<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO & REFERENCEMENT GOOGLE -->
    <title>camcardsv2 - Révisions collège avec des flashcards</title>
    <meta name="description" content="Application de révision grâce à des flashcards.">
    <meta name="keywords"
        content="flashcards collège, révisions collège, fiches de révision collège, application de révision, apprendre ses leçons">
    <meta name="author" content="Camille Cordier">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://cam-cards-v2.vercel.app/">

    <!-- Open Graph / Facebook / LinkedIn -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="camcardsv2 - Révisions collège avec des flashcards">
    <meta property="og:description" content="Application de révision grâce à des flashcards.">
    <meta property="og:url" content="https://cam-cards-v2.vercel.app/">
    <meta property="og:site_name" content="camcardsv2">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "EducationalApplication",
      "name": "camcardsv2",
      "alternateName": "CamCards v2",
      "logo": "https://cam-cards-v2.vercel.app/favicon.svg",
      "url": "https://cam-cards-v2.vercel.app/",
      "description": "Application de révision pédagogique utilisant des flashcards pour le collège.",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Any",
      "author": {
        "@type": "Person",
        "name": "Camille Cordier"
      },
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "EUR"
      }
    }
    </script>
    <!-- Favicon SVG (Livre Violet) -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237c3aed' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialiser le thème immédiatement pour éviter le flash blanc
        (function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .hidden {
            display: none !important;
        }

        .flip-card {
            perspective: 1000px;
            width: 100%;
            height: 320px;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .flip-card-front {
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border: 2px solid #ddd6fe;
        }

        .flip-card-back {
            background: white;
            transform: rotateY(180deg);
            color: #7c3aed;
            border: 3px solid #7c3aed;
        }

        .toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .progress-bar {
            transition: width 0.4s ease-in-out;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .welcome-card {
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c4b5fd;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }

        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ddd6fe;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #c4b5fd;
        }

        /* DARK MODE - Variables & Overrides */
        :root {
            --bg-primary: #f5f3ff;
            --header-bg: rgba(255, 255, 255, 0.82);
            --card-bg: white;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        html.dark {
            --bg-primary: #020617;
            --header-bg: #020617;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark body {
            background: #020617 !important;
            background-image: linear-gradient(135deg, #0f172a 0%, #020617 100%) !important;
        }

        .dark header {
            background-color: var(--header-bg) !important;
            border-bottom: 1px solid #1e293b;
            backdrop-filter: none !important;
        }

        /* Adaptation des composants existants aux thèmes */
        .dark .bg-white {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
        }

        .dark .bg-violet-50 {
            background-color: #0f172a !important;
        }

        .dark .bg-violet-100 {
            background-color: #1e1b4b !important;
        }

        .dark .text-gray-800,
        .dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .dark .text-violet-800,
        .dark .text-violet-700 {
            color: #c4b5fd !important;
        }

        .dark .border-gray-100,
        .dark .border-gray-200 {
            border-color: #334155 !important;
        }

        .dark .bg-gray-50 {
            background-color: #0f172a !important;
        }

        .dark .bg-gray-100 {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
        }

        .dark .hover\:bg-gray-100:hover {
            background-color: #334155 !important;
        }

        .dark .hover\:bg-violet-100:hover {
            background-color: #312e81 !important;
        }

        /* Modals & Inputs */
        .dark input,
        .dark select,
        .dark textarea {
            background-color: #0f172a !important;
            border-color: #334155 !important;
            color: #f8fafc !important;
        }

        .dark .modal-backdrop {
            background: rgba(0, 0, 0, 0.8) !important;
        }

        /* THEME SWITCH STYLES */
        .theme-switch {
            position: relative;
            width: 54px;
            height: 28px;
            background: #edf2f7;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }

        .dark .theme-switch {
            background: #1e293b;
            border-color: #334155;
        }

        .theme-switch .switch-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        .dark .theme-switch .switch-handle {
            left: 28px;
            background: #7c3aed;
        }

        .theme-switch svg {
            width: 14px;
            height: 14px;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .theme-switch .sun-icon {
            color: #f59e0b;
        }

        .theme-switch .moon-icon {
            color: #94a3b8;
        }

        .dark .theme-switch .sun-icon {
            color: #475569;
        }

        .dark .theme-switch .moon-icon {
            color: #c4b5fd;
        }

        /* Flip cards dark mode */
        .dark .flip-card-front {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border-color: #4338ca;
        }

        .dark .flip-card-back {
            background: #1e293b;
            color: #c4b5fd;
            border-color: #7c3aed;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: #d1d5db;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #22c55e;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 9999px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active::after {
            left: 26px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-violet-50 to-violet-100 min-h-screen">
    <div id="move-modal"
        class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Déplacer dans...</h3>
            <div id="move-subjects-list" class="space-y-2 max-h-64 overflow-y-auto mb-6">
                <!-- Matières injectées ici -->
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeMoveModal()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- HOME PAGE -->
    <div id="home-page" class="min-h-screen">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <a href="#" onclick="goHome(); return false;"
                    class="flex items-center gap-3 cursor-pointer group transition-all hover:opacity-90"
                    title="camcardsv2 - Retour à l'accueil" itemscope itemtype="http://schema.org/Brand">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-violet-500 to-violet-700 rounded-xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-shadow">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" role="img"
                            aria-label="Logo camcardsv2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <h1 class="text-xl md:text-2xl font-bold text-violet-800 leading-tight" itemprop="name">
                            camcardsv2</h1>
                        <span
                            class="text-[10px] uppercase tracking-[0.2em] text-violet-400 font-bold -mt-1 ml-0.5">Application
                            Officielle</span>
                    </div>
                </a>

                <!-- SEARCH BAR -->
                <div class="flex-1 max-w-md mx-4">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400 group-focus-within:text-violet-500 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="search-input" oninput="handleSearch(this.value)"
                            class="block w-full pl-10 pr-3 py-2 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-900 placeholder-gray-500 focus:outline-none focus:bg-white focus:ring-2 focus:ring-violet-500 focus:border-transparent sm:text-sm transition-all shadow-sm"
                            placeholder="Rechercher un pack...">
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                        <div class="switch-handle"></div>
                        <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                    </div>

                    <div id="user-header-section">
                        <!-- Will be populated by updateHomeHeader() -->
                    </div>
                </div>
            </div>
            <!-- BANNIERES D'ANNONCES -->
            <div id="announcement-banner"
                class="hidden border-t border-violet-100 bg-gradient-to-r from-violet-600 to-indigo-600 text-white overflow-hidden relative">
                <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between text-sm">
                    <div id="announcement-content" class="flex-1 text-center font-medium pr-8">
                        <!-- Message injecté ici -->
                    </div>
                    <button onclick="closeAnnouncement()"
                        class="absolute right-4 hover:bg-white/20 p-1 rounded-lg transition-colors">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-8 relative">
            <!-- Bouton flottant mobile pour feedback -->
            <button onclick="openFeedbackModal()"
                class="fixed bottom-6 right-6 z-50 p-4 bg-violet-600 text-white rounded-full shadow-2xl hover:bg-violet-700 transition-all hover:scale-110 active:scale-95 group sm:hidden"
                title="Une question ?">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                </svg>
            </button>
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-800 mb-3">Packs de Révision</h2>
                <p class="text-gray-600">Sélectionnez un pack pour commencer votre révision</p>
            </div>
            <div id="packs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

            <!-- FOOTER HOME -->
            <footer class="mt-20 py-12 border-t border-violet-100 text-center">
                <p class="text-sm text-gray-400 mb-6">camcardsv2 • Application de révision pédagogique</p>
                <button onclick="openFeedbackModal()"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-violet-50 text-violet-700 font-bold rounded-2xl hover:bg-violet-100 transition-all border border-violet-100 animate-pulse-slow">
                    <svg class="w-5 h-5 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                    </svg>
                    <span>Une question ou une idée ? Écris-nous !</span>
                </button>
            </footer>
        </main>
    </div>

    <!-- REVISION PAGE -->
    <div id="revision-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="exitRevision()"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 id="revision-pack-title" class="text-xl font-bold text-violet-800"></h2>
                <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                    <div class="switch-handle"></div>
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <main class="max-w-2xl mx-auto px-4 py-8">
            <div class="mb-8">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span id="progress-text">1 / 10</span>
                    <span id="progress-percent">10%</span>
                </div>
                <div class="h-3 bg-violet-100 rounded-full overflow-hidden">
                    <div id="progress-bar"
                        class="progress-bar h-full bg-gradient-to-r from-violet-500 to-violet-600 rounded-full"
                        style="width: 10%"></div>
                </div>
            </div>

            <div class="flip-card cursor-pointer mb-8" id="flashcard" onclick="flipCard()">
                <div class="flip-card-inner">
                    <div class="flip-card-front shadow-xl">
                        <div>
                            <p class="text-sm text-violet-500 mb-4 font-medium">QUESTION</p>
                            <p id="card-question" class="text-xl font-semibold text-gray-800"></p>
                        </div>
                    </div>
                    <div class="flip-card-back shadow-xl">
                        <div>
                            <p class="text-sm text-violet-400 mb-4 font-medium">RÉPONSE</p>
                            <p id="card-answer" class="text-xl font-semibold text-violet-700"></p>
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-center text-gray-500 text-sm mb-6">Cliquez sur la carte pour la retourner</p>

            <div class="flex justify-center gap-4">
                <button onclick="prevCard()"
                    class="flex items-center gap-2 px-6 py-3 bg-white text-violet-600 rounded-xl shadow-md hover:shadow-lg transition-all hover:-translate-y-0.5">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Précédente
                </button>
                <button onclick="resetCard()"
                    class="px-4 py-3 bg-white text-gray-500 rounded-xl shadow-md hover:shadow-lg transition-all hover:-translate-y-0.5">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
                <button onclick="nextCard()"
                    class="flex items-center gap-2 px-6 py-3 bg-violet-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all hover:-translate-y-0.5">
                    Suivante
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <div class="mt-8 flex justify-center">
                <button onclick="downloadCardsPDF()" id="download-pdf-btn"
                    class="flex items-center gap-3 px-6 py-3 bg-white text-violet-600 border-2 border-violet-200 rounded-xl shadow-md hover:shadow-lg hover:bg-violet-50 hover:border-violet-300 transition-all hover:-translate-y-0.5">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 11v6m0 0l-2-2m2 2l2-2" />
                    </svg>
                    <span>Télécharger les cartes version papier</span>
                    <span class="text-xs bg-violet-100 text-violet-600 px-2 py-1 rounded-full font-medium">PDF</span>
                </button>
            </div>
        </main>
    </div>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="min-h-screen hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <button onclick="showPage('home-page')"
                class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors mb-6">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Retour
            </button>

            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-violet-100">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Connexion</h2>
                <p class="text-gray-500 mt-2">Accédez à votre espace CamCards v2</p>
            </div>

            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                        <input type="text" id="login-nom"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="Votre nom">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                        <input type="text" id="login-prenom"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="Votre prénom">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                        <input type="password" id="login-password"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="••••••••">
                    </div>
                </div>

                <div id="login-error"
                    class="hidden mt-4 p-3 bg-red-50 text-red-600 rounded-xl text-sm flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="login-error-text">Identifiants incorrects</span>
                </div>

                <button type="submit"
                    class="w-full mt-6 py-3 bg-gradient-to-r from-violet-600 to-violet-700 text-white font-semibold rounded-xl hover:from-violet-700 hover:to-violet-800 transition-all shadow-lg hover:shadow-xl">
                    Se connecter
                </button>
            </form>

            <div class="mt-6 pt-6 border-t border-gray-100 text-center">
                <p class="text-gray-500 text-sm mb-3">Pas encore de compte ?</p>
                <button onclick="showPage('register-page')"
                    class="flex items-center justify-center gap-2 w-full py-3 bg-violet-50 text-violet-700 font-medium rounded-xl hover:bg-violet-100 transition-all border border-violet-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                    Créer mon compte
                </button>
            </div>
        </div>
    </div>

    <!-- REGISTER PAGE -->
    <div id="register-page" class="min-h-screen hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <button onclick="showPage('login-page')"
                class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors mb-6">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Retour
            </button>

            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-100">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Créer mon compte</h2>
                <p class="text-gray-500 mt-2">Rejoignez la communauté CamCards v2</p>
            </div>

            <form id="register-form" onsubmit="handleRegister(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                        <input type="text" id="register-nom" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="Votre nom">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                        <input type="text" id="register-prenom" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="Votre prénom">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                        <input type="password" id="register-password" required minlength="6"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="••••••••">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmer le mot de passe</label>
                        <input type="password" id="register-password-confirm" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="••••••••">
                    </div>
                </div>

                <div id="register-error"
                    class="hidden mt-4 p-3 bg-red-50 text-red-600 rounded-xl text-sm flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="register-error-text">Erreur</span>
                </div>

                <button type="submit"
                    class="w-full mt-6 py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-violet-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                    Créer mon compte
                </button>
            </form>

            <div class="mt-6 p-4 bg-violet-50 rounded-xl border border-violet-100">
                <div class="flex gap-3 text-left">
                    <svg class="w-5 h-5 text-violet-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-xs text-violet-800 leading-relaxed">
                        Créez votre compte pour accéder instantanément au contenu. Vous pourrez ensuite demander à un
                        administrateur de vous promouvoir pour accéder aux outils de création.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboard-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity"
                    onclick="goHome()">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-violet-500 to-violet-700 rounded-xl flex items-center justify-center shadow-sm">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-bold text-violet-800 leading-tight">camcardsv2</span>
                        <span
                            class="text-[10px] uppercase tracking-wider text-violet-400 font-bold">Administration</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                        <div class="switch-handle"></div>
                        <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                    </div>
                    <button onclick="handleLogout()"
                        class="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-xl transition-colors"
                        title="Déconnexion">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span class="hidden sm:inline">Déconnexion</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <div class="text-center mb-10">
                <h2 id="welcome-message" class="text-3xl font-bold text-gray-800 mb-3">Bienvenue !</h2>
                <p class="text-gray-600">Gérez vos packs de flashcards</p>
            </div>

            <!-- Grille d'actions principale -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                <button onclick="currentSubjectId = null; showPage('manage-packs-page')"
                    class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center group">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-violet-100 to-violet-200 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-violet-200 group-hover:to-violet-300 transition-all">
                        <svg class="w-8 h-8 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Modifier un pack</h3>
                    <p class="text-gray-500 text-sm">Ajouter, modifier ou supprimer des packs</p>
                </button>

                <button onclick="currentSubjectId = null; showPage('preview-packs-page')"
                    class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center group">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-violet-100 to-violet-200 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-violet-200 group-hover:to-violet-300 transition-all">
                        <svg class="w-8 h-8 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Flashcard</h3>
                    <p class="text-gray-500 text-sm">Tester les packs comme un élève</p>
                </button>

                <button onclick="showPage('backup-page')"
                    class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center group">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-violet-100 to-violet-200 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-violet-200 group-hover:to-violet-300 transition-all">
                        <svg class="w-8 h-8 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Sauvegarde</h3>
                    <p class="text-gray-500 text-sm">Import/Export des données</p>
                </button>

                <button onclick="showPage('manage-admins-page')"
                    class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center group relative">
                    <div id="pending-badge"
                        class="hidden absolute top-4 right-4 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
                    </div>
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-violet-100 to-violet-200 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-violet-200 group-hover:to-violet-300 transition-all">
                        <svg class="w-8 h-8 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Gérer les administrateurs</h3>
                    <p class="text-gray-500 text-sm">Administration des comptes</p>
                </button>

                <!-- CENTRE DE COMMUNICATION -->
                <button onclick="showPage('comm-page')"
                    class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center group relative border-2 border-transparent hover:border-violet-200">
                    <div id="comm-notif-badge"
                        class="hidden absolute top-4 right-4 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center animate-bounce">
                        !
                    </div>
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-violet-100 to-violet-200 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-violet-200 group-hover:to-violet-300 transition-all">
                        <svg class="w-8 h-8 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Centre de Communication</h3>
                    <p class="text-gray-500 text-sm">Annonces, Retours & Admin Notes</p>
                </button>
            </div>

            <!-- Bouton Analytique Discret -->
            <div class="mt-12 pt-8 border-t border-gray-100 flex justify-center">
                <button onclick="showPage('analytics-page')"
                    class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-400 hover:text-violet-600 hover:bg-violet-50 rounded-xl transition-all group">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                    </svg>
                    <span>Statistiques du site</span>
                </button>
            </div>
        </main>
    </div>

    <!-- ANALYTICS PAGE -->
    <div id="analytics-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="showPage('dashboard-page')"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 class="text-xl font-bold text-violet-800">Analyses Trafic</h2>
                <div class="w-10"></div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-violet-100">
                    <p class="text-sm text-gray-500 font-bold uppercase tracking-wider mb-1">Visites Totales</p>
                    <p id="ana-total-visits" class="text-3xl font-bold text-gray-800">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-violet-500 bg-violet-50">
                    <p class="text-sm text-violet-600 font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        En Ligne Direct
                    </p>
                    <p id="ana-online-users" class="text-3xl font-bold text-violet-800">1</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-6">Évolution des 30 derniers jours</h3>
                <div class="h-64 sm:h-80">
                    <canvas id="visitsChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- MANAGE ADMINS PAGE -->
    <div id="manage-admins-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="currentSubjectId = null; showPage('dashboard-page')"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 class="text-xl font-bold text-violet-800">Gérer les Utilisateurs</h2>
                <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                    <div class="switch-handle"></div>
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    Tous les utilisateurs
                </h3>
                <div id="all-users-list" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <!-- COMMUNICATION PAGE (ADMIN) -->
    <div id="comm-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="showPage('dashboard-page')"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 class="text-xl font-bold text-violet-800">Centre de Communication</h2>
                <div class="w-10"></div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- COLONNE GAUCHE: ANNONCES -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-violet-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.167H3.38a1.345 1.345 0 01-1.345-1.345V10.16a1.345 1.345 0 011.345-1.345h1.01l2.147-6.167a1.76 1.76 0 013.417.592zM15 8.75l3 3-3 3M21 12h-3" />
                            </svg>
                            📣 Annonces Élèves
                        </h3>
                        <div class="space-y-4">
                            <textarea id="comm-ann-text"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-violet-500 outline-none transition-all"
                                rows="3" placeholder="Tapez votre annonce ici..."></textarea>
                            <button onclick="postAnnouncement()"
                                class="w-full py-2 bg-violet-600 text-white font-medium rounded-xl hover:bg-violet-700 transition-colors">
                                Publier l'annonce
                            </button>
                        </div>
                        <div id="comm-ann-list" class="mt-6 space-y-3">
                            <!-- Liste des annonces ici -->
                        </div>
                    </div>
                </div>

                <!-- COLONNE CENTRE: ADMIN NOTES -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-indigo-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
                            </svg>
                            💬 Mur Inter-Admins
                        </h3>
                        <div class="space-y-4">
                            <textarea id="comm-admin-note"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                rows="3" placeholder="Laissez une note pour les autres admins..."></textarea>
                            <button onclick="postAdminNote()"
                                class="w-full py-2 bg-indigo-600 text-white font-medium rounded-xl hover:bg-indigo-700 transition-colors">
                                Ajouter au mur
                            </button>
                        </div>
                        <div id="comm-admin-notes-list"
                            class="mt-6 space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Notes ici -->
                        </div>
                    </div>
                </div>

                <!-- COLONNE DROITE: FEEDBACK ÉLÈVES -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-emerald-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            📩 Retours Utilisateurs
                        </h3>
                        <div id="comm-feedback-list"
                            class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Retours ici -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- FEEDBACK MODAL (USER) -->
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden relative">
            <div class="p-8">
                <div class="w-16 h-16 bg-violet-100 rounded-2xl flex items-center justify-center mb-6 mx-auto">
                    <svg class="w-8 h-8 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-2">Une suggestion ?</h3>
                <p class="text-center text-gray-500 mb-8">Un bug, une idée ou besoin d'un pack spécifique ? Dis-le nous
                    !</p>

                <div class="space-y-4">
                    <textarea id="feedback-text"
                        class="w-full px-4 py-3 border border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-violet-500 outline-none transition-all"
                        rows="4" placeholder="Ton message..."></textarea>

                    <div class="flex gap-3">
                        <button onclick="closeFeedbackModal()"
                            class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-2xl hover:bg-gray-200 transition-all">
                            Annuler
                        </button>
                        <button onclick="sendFeedback()"
                            class="flex-2 py-3 bg-violet-600 text-white font-bold rounded-2xl hover:bg-violet-700 transition-all shadow-lg shadow-violet-200">
                            Envoyer le message
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MANAGE PACKS PAGE -->
    <div id="manage-packs-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="handleManagePacksBack()"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 class="text-xl font-bold text-violet-800">Gérer les Packs</h2>
                <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                    <div class="switch-handle"></div>
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <div class="flex flex-wrap gap-4 mb-6">
                <button onclick="addNewPack()"
                    class="flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Ajouter un pack
                </button>
                <button onclick="toggleDeleteMode()" id="delete-mode-btn"
                    class="flex items-center gap-2 px-4 py-2 bg-white text-red-600 border border-red-200 rounded-xl hover:bg-red-50 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Supprimer des packs
                </button>
                <button onclick="deleteSelectedPacks()" id="confirm-delete-btn"
                    class="hidden flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Confirmer la suppression
                </button>
            </div>
            <div id="manage-packs-list" class="space-y-4"></div>
        </main>
    </div>

    <!-- EDIT PACK PAGE -->
    <div id="edit-pack-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="safeBackFromEditPack()"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 class="text-xl font-bold text-violet-800">Éditer le Pack</h2>
                <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                    <div class="switch-handle"></div>
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Titre du pack</label>
                        <input type="text" id="edit-pack-title" oninput="hasUnsavedChanges = true"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Niveau / Classe</label>
                        <select id="edit-pack-level"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all appearance-none bg-white">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Matière / Dossier</label>
                        <select id="edit-pack-subject"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all appearance-none bg-white">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Icône (emoji)</label>
                        <input type="text" id="edit-pack-icon" oninput="hasUnsavedChanges = true"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all"
                            placeholder="📚">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="edit-pack-desc" oninput="hasUnsavedChanges = true"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none transition-all resize-none"
                            rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-6">
                <button onclick="addCardToEdit()"
                    class="flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Ajouter une carte
                </button>
                <button onclick="openImportModal()"
                    class="flex items-center gap-2 px-4 py-2 bg-white text-violet-600 border border-violet-200 rounded-xl hover:bg-violet-50 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Importer plusieurs cartes
                </button>
                <button onclick="saveEditedPack()"
                    class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors ml-auto">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Enregistrer
                </button>
            </div>

            <div id="edit-cards-list" class="space-y-4"></div>
        </main>
    </div>

    <!-- PREVIEW PACKS PAGE -->
    <div id="preview-packs-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="handlePreviewPacksBack()"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 class="text-xl font-bold text-violet-800">Prévisualisation</h2>
                <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                    <div class="switch-handle"></div>
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="text-center mb-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Tester un Pack</h2>
                <p class="text-gray-600">Sélectionnez un pack pour le tester comme un élève</p>
            </div>
            <div id="preview-packs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>
    </div>

    <!-- BACKUP PAGE -->
    <div id="backup-page" class="min-h-screen hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="safeBackToLevels()"
                    class="flex items-center gap-2 text-violet-600 hover:text-violet-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Retour</span>
                </button>
                <h2 class="text-xl font-bold text-violet-800">Sauvegarde & Import</h2>
                <div class="theme-switch" onclick="toggleTheme()" title="Changer le thème">
                    <div class="switch-handle"></div>
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Exporter les données
                </h3>
                <div class="flex flex-wrap gap-4 mb-4">
                    <button onclick="downloadJSON()"
                        class="flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Télécharger le fichier
                    </button>
                    <button onclick="showExportText()"
                        class="flex items-center gap-2 px-4 py-2 bg-white text-violet-600 border border-violet-200 rounded-xl hover:bg-violet-50 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copier le texte
                    </button>
                </div>
                <div id="export-text-container" class="hidden">
                    <textarea id="export-text"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl font-mono text-sm bg-gray-50" rows="8"
                        readonly></textarea>
                    <button onclick="copyExportText()"
                        class="mt-2 flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copier dans le presse-papier
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Importer des données
                </h3>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mode d'import</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="import-mode" value="replace" checked
                                class="w-4 h-4 text-violet-600">
                            <span class="text-gray-700">Remplacer tout</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="import-mode" value="merge" class="w-4 h-4 text-violet-600">
                            <span class="text-gray-700">Additionner (Merge)</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Importer un fichier JSON</label>
                    <div
                        class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center hover:border-violet-300 transition-colors">
                        <input type="file" id="import-file" accept=".json" class="hidden"
                            onchange="handleFileImport(event)">
                        <label for="import-file" class="cursor-pointer">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="text-gray-600">Cliquez pour sélectionner un fichier</p>
                            <p class="text-gray-400 text-sm mt-1">ou glissez-déposez ici</p>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ou collez le JSON ici</label>
                    <textarea id="import-text"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl font-mono text-sm" rows="6"
                        placeholder='{"packs": [...]}'></textarea>
                </div>

                <button onclick="importFromText()"
                    class="flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Importer
                </button>
            </div>
        </main>
    </div>

    <!-- IMPORT CARDS MODAL -->
    <div id="import-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800">Importer plusieurs cartes</h3>
                <button onclick="closeImportModal()" class="p-2 hover:bg-gray-100 rounded-xl transition-colors">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <p class="text-gray-600 mb-4">Collez vos cartes au format : <code
                        class="bg-gray-100 px-2 py-1 rounded text-sm">("Question", "Réponse"), ("Q2", "R2")</code></p>
                <textarea id="import-cards-text"
                    class="w-full px-4 py-3 border border-gray-200 rounded-xl font-mono text-sm" rows="6"
                    placeholder='("Quelle est la capitale de la France ?", "Paris"), ("2 + 2 ?", "4")'></textarea>

                <div class="mt-4 pt-4 border-t border-gray-100 text-center">
                    <p class="text-xs text-gray-500 mb-3 uppercase tracking-wider font-bold">Ou importation CSV</p>
                    <input type="file" id="import-cards-csv" accept=".csv" class="hidden"
                        onchange="handleCSVCardsImport(event)">
                    <label for="import-cards-csv"
                        class="flex items-center justify-center gap-2 w-full py-3 bg-violet-50 text-violet-700 font-medium rounded-xl hover:bg-violet-100 transition-all border border-violet-100 cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Choisir un fichier CSV
                    </label>
                    <div id="csv-filename" class="text-xs text-gray-400 mt-2 italic px-2"></div>
                </div>

                <div id="import-preview" class="mt-4 hidden">
                    <h4 class="font-semibold text-gray-700 mb-2">Aperçu :</h4>
                    <div id="import-preview-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 flex justify-end gap-4">
                <button onclick="previewImportCards()"
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors">
                    Prévisualiser
                </button>
                <button onclick="confirmImportCards()"
                    class="px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                    Importer
                </button>
            </div>
        </div>
    </div>

    <script>
        // DATA
        const DEFAULT_DATA_WITH_EXAMPLES = {
            packs: [
                {
                    id: 1,
                    title: "Maths 3ème",
                    description: "Révision du programme de mathématiques",
                    icon: "📐",
                    published: true,
                    cards: [
                        { question: "Quelle est la formule de l'aire d'un cercle ?", answer: "A = π × r²" },
                        { question: "Comment calcule-t-on le théorème de Pythagore ?", answer: "a² + b² = c² (dans un triangle rectangle)" },
                        { question: "Qu'est-ce qu'une fonction linéaire ?", answer: "Une fonction de la forme f(x) = ax" },
                        { question: "Quelle est la formule du volume d'une sphère ?", answer: "V = (4/3) × π × r³" },
                        { question: "Comment factoriser a² - b² ?", answer: "(a - b)(a + b)" }
                    ]
                },
                {
                    id: 2,
                    title: "Histoire - Révolution",
                    description: "La Révolution française 1789-1799",
                    icon: "🏛️",
                    published: true,
                    cards: [
                        { question: "Quand a eu lieu la prise de la Bastille ?", answer: "Le 14 juillet 1789" },
                        { question: "Qui était le roi de France en 1789 ?", answer: "Louis XVI" },
                        { question: "Qu'est-ce que le Tiers-État ?", answer: "L'ensemble des personnes n'appartenant ni à la noblesse ni au clergé" },
                        { question: "Quand a été proclamée la Première République ?", answer: "Le 21 septembre 1792" }
                    ]
                },
                {
                    id: 3,
                    title: "Anglais - Vocabulaire",
                    description: "Mots essentiels pour le brevet",
                    icon: "🇬🇧",
                    published: true,
                    cards: [
                        { question: "Comment dit-on 'cependant' en anglais ?", answer: "However / Nevertheless" },
                        { question: "Traduire : 'I have been living here for 5 years'", answer: "J'habite ici depuis 5 ans" },
                        { question: "Quel est le prétérit de 'to write' ?", answer: "Wrote" },
                        { question: "Comment dit-on 'bien que' en anglais ?", answer: "Although / Even though" }
                    ]
                },
                {
                    id: 4,
                    title: "SVT - Le corps humain",
                    description: "Anatomie et physiologie de base",
                    icon: "🧬",
                    published: true,
                    cards: [
                        { question: "Combien d'os compte le corps humain adulte ?", answer: "206 os" },
                        { question: "Quel organe produit l'insuline ?", answer: "Le pancréas" },
                        { question: "Quelle est la fonction des globules rouges ?", answer: "Transporter l'oxygène dans le sang" },
                        { question: "Où se situe l'ADN dans une cellule ?", answer: "Dans le noyau" }
                    ]
                },
                {
                    id: 5,
                    title: "Physique-Chimie",
                    description: "Concepts fondamentaux",
                    icon: "⚗️",
                    published: true,
                    cards: [
                        { question: "Quelle est la formule de l'eau ?", answer: "H₂O" },
                        { question: "Quelle est l'unité de mesure de la force ?", answer: "Le Newton (N)" },
                        { question: "Quelle est la vitesse de la lumière ?", answer: "≈ 300 000 km/s (3×10⁸ m/s)" },
                        { question: "Qu'est-ce qu'un atome ?", answer: "La plus petite unité de matière conservant les propriétés d'un élément" }
                    ]
                },
                {
                    id: 6,
                    title: "Géographie - France",
                    description: "Reliefs, fleuves et régions",
                    icon: "🗺️",
                    published: true,
                    cards: [
                        { question: "Quels sont les 5 grands fleuves français ?", answer: "La Seine, La Loire, La Garonne, Le Rhône, Le Rhin" },
                        { question: "Quel est le plus haut sommet de France ?", answer: "Le Mont Blanc (4 808 m)" },
                        { question: "Combien y a-t-il de régions en France métropolitaine ?", answer: "13 régions (depuis 2016)" }
                    ]
                }
            ],
            users: []
        };


        // --- CONFIGURATION SUPABASE ---
        // Remplacez ces valeurs par les vôtres si elles changent
        const SUPABASE_URL = 'https://yeluzuevhjljmrruixdq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_sfRlRz-a6QqeNYBPUTi7Fg__M6OjTAc';

        // Initialisation du client
        // Initialisation du client
        let supabaseClient = null;
        try {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                console.error("Supabase lib not loaded");
                showToast("Erreur: Librairie Supabase non chargée", "error");
            }
        } catch (e) {
            console.error("Supabase init error:", e);
        }

        // DATA DEFAULT (Structure vide pour démarrage)
        const DEFAULT_DATA = {
            levels: [
                { id: '6e', name: '6ème', icon: '🎓' },
                { id: '5e', name: '5ème', icon: '🎒' },
                { id: '4e', name: '4ème', icon: '📝' },
                { id: '3e', name: '3ème', icon: '🧪' }
            ],
            users: [],
            announcements: [],
            feedback: [],
            admin_notes: []
        };

        // SAVE DATA
        let appData = JSON.parse(JSON.stringify(DEFAULT_DATA));



        // STATE VARIABLES
        let currentUser = null;
        let currentLevelId = null;
        let currentSubjectId = null;
        let editingPackId = null;
        let editingCards = [];
        let searchQuery = '';
        let bulkMode = null; // 'delete' or 'move'
        let selectedItems = new Set();
        let hasUnsavedChanges = false;
        let deleteMode = false;
        let moveMode = false;
        let currentPackId = null;
        let currentCardIndex = 0;
        let isAdminPreview = false;
        let pendingMoveSubjectId = null;
        let activePage = 'home-page'; // Suivi de la page active
        // --- THÈME (MODE SOMBRE) ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // --- GESTION DES DONNÉES (SUPABASE) ---

        // Pour que Supabase fonctionne, vous devez créer une table 'app_data' dans votre projet Supabase.
        // Voici le SQL à exécuter dans l'éditeur SQL de Supabase:
        /*
        CREATE TABLE app_data (
          id TEXT PRIMARY KEY,
          json_content JSONB
        );

        -- Activez RLS (Row Level Security) pour la table app_data
        ALTER TABLE app_data ENABLE ROW LEVEL SECURITY;

        -- Créez une politique pour permettre l'accès en lecture/écriture à tout le monde (pour cet exemple simple)
        -- Dans un environnement de production, vous voudriez des politiques plus restrictives.
        CREATE POLICY "Allow public read/write access" ON app_data
        FOR ALL USING (true) WITH CHECK (true);
        */

        // Charger tout l'état depuis le Cloud (Supabase) ou LocalStorage
        async function loadData() {
            try {
                let initialData = null;

                // 1. Tenter le chargement depuis Supabase
                if (supabaseClient) {
                    const { data, error } = await supabaseClient
                        .from('app_data')
                        .select('json_content')
                        .eq('id', 'global_store')
                        .single();

                    if (!error && data && data.json_content) {
                        initialData = data.json_content;
                        console.log("Données chargées depuis le Cloud");
                    }
                }

                // 2. Si pas de Cloud, tenter le LocalStorage (avec migration forcée)
                if (!initialData) {
                    const localDataV2 = localStorage.getItem('camcards_v2_data');
                    const localDataV1 = localStorage.getItem('flashcamedu_data');

                    if (localDataV2) {
                        initialData = JSON.parse(localDataV2);
                        console.log("Données chargées localement (V2)");
                    } else if (localDataV1) {
                        initialData = JSON.parse(localDataV1);
                        console.log("Données migrées localement (V1 -> V2)");
                        localStorage.setItem('camcards_v2_data', localDataV1);
                    }
                }

                // 3. Fallback final sur les données d'exemple si rien n'est trouvé
                if (!initialData) {
                    console.log("Initialisation avec les données d'exemple...");
                    initialData = JSON.parse(JSON.stringify(DEFAULT_DATA_WITH_EXAMPLES));
                }

                // Application des données
                appData = initialData;
                ensureDataIntegrity();

                // Incrémenter le compteur de visites (une fois par session navigateur)
                if (appData && !sessionStorage.getItem('visited')) {
                    if (!appData.stats) appData.stats = { totalVisits: 0, lastVisit: null, history: {} };
                    if (!appData.stats.history) appData.stats.history = {};

                    appData.stats.totalVisits = (appData.stats.totalVisits || 0) + 1;
                    appData.stats.lastVisit = new Date().toISOString();

                    const today = new Date().toISOString().split('T')[0];
                    appData.stats.history[today] = (appData.stats.history[today] || 0) + 1;

                    sessionStorage.setItem('visited', 'true');
                    saveData(); // Sauvegarder l'incrément
                }

                currentLevelId = null;
                currentSubjectId = null;
                searchQuery = "";

                // Auto-login si session persistante
                const savedUserId = localStorage.getItem('camcards_v2_user_id');
                if (savedUserId) {
                    const user = appData.users.find(u => u.id === parseInt(savedUserId));
                    if (user) {
                        currentUser = user;
                        // Role-based redirect
                        if (user.role === 'admin') {
                            showPage('dashboard-page');
                        } else {
                            showPage('home-page');
                        }
                        console.log('Session restaurée pour:', user.prenom, user.nom);
                    } else {
                        // User deleted
                        localStorage.removeItem('camcards_v2_user_id');
                    }
                }

                updateHomeHeader();
                updateDashboard();
                renderPacksGrid();
                renderAdminsPage();
                checkWelcomeModal();
            } catch (err) {
                console.error("Exception load:", err);
            }
        }

        // --- TRACKING PRÉSENCE ---
        let sessionProxyId = sessionStorage.getItem('analytics_proxy_id');
        if (!sessionProxyId) {
            sessionProxyId = Math.random().toString(36).substring(7);
            sessionStorage.setItem('analytics_proxy_id', sessionProxyId);
        }

        function pingPresence() {
            if (!appData || !appData.presence) return;
            appData.presence[sessionProxyId] = new Date().toISOString();

            // Nettoyer les pings vieux de plus de 2 minutes (plus agressif pour éviter les doublons)
            const threshold = new Date(Date.now() - 2 * 60 * 1000);
            Object.keys(appData.presence).forEach(id => {
                if (new Date(appData.presence[id]) < threshold) {
                    delete appData.presence[id];
                }
            });

            saveData(true); // Argument "silent" pour éviter les logs excessifs
        }
        setInterval(pingPresence, 15000); // Ping toutes les 15 secondes

        function getOnlineCount() {
            if (!appData || !appData.presence) return 1;
            const threshold = new Date(Date.now() - 2 * 60 * 1000);
            return Object.values(appData.presence).filter(time => new Date(time) > threshold).length || 1;
        }

        async function syncAnalytics() {
            if (activePage !== 'analytics-page') return;

            try {
                if (supabaseClient) {
                    const { data, error } = await supabaseClient
                        .from('app_data')
                        .select('json_content')
                        .eq('id', 'global_store')
                        .single();

                    if (!error && data && data.json_content) {
                        const cloudData = data.json_content;
                        if (cloudData.stats) appData.stats = cloudData.stats;
                        if (cloudData.presence) appData.presence = cloudData.presence;

                        // Fusion intelligente des messages pour ne rien rater
                        if (cloudData.announcements) appData.announcements = cloudData.announcements;
                        if (cloudData.admin_notes) appData.admin_notes = cloudData.admin_notes;
                        if (cloudData.feedback) appData.feedback = cloudData.feedback;

                        updateDashboard();
                        renderVisitsChart();
                        if (activePage === 'comm-page') renderCommHub();
                        if (activePage === 'home-page') renderAnnouncements();
                    }
                }
            } catch (err) {
                console.error("Sync error:", err);
            }
        }
        setInterval(syncAnalytics, 5000); // Sync toutes les 5 secondes si sur la page stats

        let visitsChart = null;
        function renderVisitsChart() {
            const ctx = document.getElementById('visitsChart').getContext('2d');

            // Préparer les données
            const labels = [];
            const values = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const displayDate = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });

                labels.push(displayDate);
                values.push(appData.stats.history ? (appData.stats.history[dateStr] || 0) : 0);
            }

            if (visitsChart) {
                // Mise à jour silencieuse si le graphique existe déjà
                visitsChart.data.labels = labels;
                visitsChart.data.datasets[0].data = values;
                visitsChart.update('none'); // Pas d'animation pour les updates
                return;
            }

            visitsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visites',
                        data: values,
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#7c3aed',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return `${context.parsed.y} visiteurs`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function ensureDataIntegrity() {
            if (!appData.levels) appData.levels = [
                { id: '6e', name: '6ème', icon: '🎓' },
                { id: '5e', name: '5ème', icon: '🎒' },
                { id: '4e', name: '4ème', icon: '📝' },
                { id: '3e', name: '3ème', icon: '🧪' }
            ];
            if (!appData.subjects) appData.subjects = [];
            if (!appData.packs) appData.packs = [];
            if (!appData.stats) appData.stats = { totalVisits: 0, lastVisit: null, history: {} };
            if (!appData.stats.history) appData.stats.history = {};
            if (!appData.presence) appData.presence = {};
            if (!appData.announcements) appData.announcements = [];
            if (!appData.feedback) appData.feedback = [];
            if (!appData.admin_notes) appData.admin_notes = [];

            // MIGRATION: admins → users with role field
            // Note: On utilise la notation entre crochets pour éviter que le global replace ne change 'admins'
            if (appData['admins'] && !appData['users_migrated']) {
                appData.users = appData['admins'].map(admin => ({
                    id: admin.id,
                    nom: admin.nom,
                    prenom: admin.prenom,
                    password: admin.password,
                    role: 'admin',
                    createdAt: admin.createdAt || new Date().toISOString(),
                    lastLogin: null
                }));
                delete appData['admins'];
                appData['users_migrated'] = true;
                console.log('Migration: admins → users completed');
            }

            if (!appData.users) appData.users = [];

            // S'assurer que chaque utilisateur a un rôle
            appData.users.forEach(u => {
                if (!u.role) u.role = 'user';

                if (u.nom === "Cordier" && u.prenom === "Camille") {
                    u.role = 'admin';
                    u.superAdmin = true;
                }

                // S'assurer que hasSeenWelcome existe
                if (u.hasSeenWelcome === undefined) {
                    u.hasSeenWelcome = false;
                }
            });

            // 1. S'assurer que tous les packs ont un levelId
            appData.packs.forEach(pack => {
                if (!pack.levelId) {
                    const title = pack.title.toLowerCase();
                    if (title.includes('3e') || title.includes('3ème')) pack.levelId = '3e';
                    else if (title.includes('4e') || title.includes('4ème')) pack.levelId = '4e';
                    else if (title.includes('5e') || title.includes('5ème')) pack.levelId = '5e';
                    else if (title.includes('6e') || title.includes('6ème')) pack.levelId = '6e';
                    else pack.levelId = appData.levels[0].id;
                }
                if (!pack.cards) pack.cards = [];
            });

            // 2. Découplage des matières par niveau
            const newSubjects = [];
            const subjectMap = {}; // "oldSubjectId_levelId" -> newSubjectId

            // On parcourt tous les packs pour recréer les matières nécessaires par niveau
            appData.packs.forEach(pack => {
                const oldSubjectId = pack.subjectId;
                const levelId = pack.levelId;
                const key = `${oldSubjectId}_${levelId}`;

                if (!subjectMap[key]) {
                    const oldSubject = appData.subjects.find(s => s.id === oldSubjectId) || { name: 'Divers', icon: '📁' };
                    const newId = newSubjects.length + 1;
                    newSubjects.push({
                        id: newId,
                        name: oldSubject.name,
                        icon: oldSubject.icon,
                        levelId: levelId
                    });
                    subjectMap[key] = newId;
                }
                pack.subjectId = subjectMap[key];
            });

            // Si aucune matière n'a été créée (pas de packs), on initialise par défaut pour chaque niveau
            if (newSubjects.length === 0) {
                appData.levels.forEach((l, idx) => {
                    newSubjects.push({ id: idx + 1, name: "Divers", icon: "📁", levelId: l.id });
                });
            }

            appData.subjects = newSubjects;
        }

        // Helper pour rafraîchir la page active correctement
        function renderActivePage() {
            const visiblePage = Array.from(document.querySelectorAll('[id$="-page"]')).find(p => !p.classList.contains('hidden'));
            if (visiblePage) {
                const id = visiblePage.id;
                if (id === 'home-page') { renderPacksGrid(); renderAnnouncements(); }
                else if (id === 'manage-packs-page') renderManagePacksList();
                else if (id === 'preview-packs-page') renderPreviewPacksGrid();
                else if (id === 'dashboard-page') updateDashboard();
                else if (id === 'manage-admins-page') renderAdminsPage();
                else if (id === 'comm-page') renderCommHub();
            }
        }

        // Sauvegarder tout l'état vers Supabase ou LocalStorage
        async function saveData(silent = false) {
            try {
                // Sauvegarde locale systématique
                localStorage.setItem('camcards_v2_data', JSON.stringify(appData));

                if (supabaseClient) {
                    // Pour éviter d'écraser les pings des autres, on récupère le cloud juste avant de sauvegarder
                    // C'est une fusion basique
                    if (!silent) {
                        const { data } = await supabaseClient.from('app_data').select('json_content').eq('id', 'global_store').single();
                        if (data && data.json_content) {
                            const cloudPresence = data.json_content.presence || {};
                            // Fusionner les présences (le local gagne sur son propre ID)
                            appData.presence = { ...cloudPresence, ...appData.presence };
                        }
                    }

                    // Upsert Cloud
                    const { error } = await supabaseClient
                        .from('app_data')
                        .upsert({
                            id: 'global_store',
                            json_content: appData
                        });

                    if (error) {
                        console.error("Erreur sauvegarde Supabase:", error);
                        showToast("Erreur de sync Cloud", "warning");
                    } else {
                        console.log("Sauvegarde Cloud OK");
                    }
                }
            } catch (err) {
                console.error("Exception save:", err);
            }
        }

        // --- FONCTIONS UTILITAIRES (Modifiée pour ne plus dépendre du serveur local) ---

        function resetNav() {
            currentLevelId = null;
            currentSubjectId = null;
            document.getElementById('search-input').value = '';
            renderPacksGrid();
        }

        function goHome() {
            if (currentUser && (currentUser.role === 'admin' || currentUser.superAdmin)) {
                showPage('dashboard-page');
            } else {
                resetNav();
                showPage('home-page');
            }
        }

        function showPage(pageId) {
            activePage = pageId;
            document.querySelectorAll('[id$="-page"]').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');

            if (pageId === 'home-page') renderPacksGrid();
            else if (pageId === 'manage-packs-page') renderManagePacksList();
            else if (pageId === 'preview-packs-page') renderPreviewPacksGrid();
            else if (pageId === 'dashboard-page') updateDashboard();
            else if (pageId === 'manage-admins-page') renderAdminsPage();
            else if (pageId === 'analytics-page') {
                updateDashboard();
                renderVisitsChart();
            }
            else if (pageId === 'comm-page') {
                renderCommHub();
            }
        }

        function safeBackFromEditPack() {
            if (hasUnsavedChanges) {
                if (!confirm("Voulez-vous vraiment quitter ? Vos modifications non enregistrées seront perdues.")) {
                    return;
                }
            }
            hasUnsavedChanges = false;
            showPage('manage-packs-page');
            renderManagePacksList();
        }

        function safeBackToLevels() {
            if (hasUnsavedChanges) {
                if (!confirm("Voulez-vous vraiment quitter ? Vos modifications non enregistrées seront perdues.")) {
                    return;
                }
            }
            hasUnsavedChanges = false;
            currentSubjectId = null;
            showPage('dashboard-page');
        }

        // Alerte avant de quitter l'onglet si modifications
        window.onbeforeunload = function (e) {
            if (hasUnsavedChanges) {
                return "Vous avez des modifications non enregistrées. Voulez-vous vraiment quitter ?";
            }
        };

        function handleManagePacksBack() {
            if (currentSubjectId !== null) {
                currentSubjectId = null;
                deleteMode = false;
                moveMode = false;
                renderManagePacksList();
            } else if (currentLevelId !== null) {
                currentLevelId = null;
                renderManagePacksList();
            } else {
                showPage('dashboard-page');
            }
        }

        function handlePreviewPacksBack() {
            if (currentSubjectId !== null) {
                currentSubjectId = null;
                renderPreviewPacksGrid();
            } else if (currentLevelId !== null) {
                currentLevelId = null;
                renderPreviewPacksGrid();
            } else {
                showPage('dashboard-page');
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-violet-500'
                } text-white`;

            const icon = type === 'success'
                ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                : type === 'error'
                    ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
                    : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';

            toast.innerHTML = `${icon}<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // SEARCH & FUZZY LOGIC
        function handleSearch(query) {
            renderPacksGrid(query);
        }

        // Levenshtein Distance (pour la tolérance aux fautes)
        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        // PACKS RENDERING (Public Home)
        function renderPacksGrid(query = null) {
            const grid = document.getElementById('packs-grid');
            if (query !== null) searchQuery = query;
            const isSearching = searchQuery.trim().length > 0;
            let visiblePacks = appData.packs.filter(pack => pack.published !== false);

            if (isSearching) {
                const lowerQuery = searchQuery.toLowerCase().trim();
                visiblePacks = visiblePacks.filter(pack => {
                    const title = pack.title.toLowerCase();
                    const desc = pack.description.toLowerCase();
                    if (title.includes(lowerQuery) || desc.includes(lowerQuery)) return true;
                    // Fuzzy search
                    const words = lowerQuery.split(' ');
                    return words.some(word => {
                        if (word.length < 3) return false;
                        const titleWords = title.split(' ');
                        const descWords = desc.split(' ');
                        if (titleWords.some(tWord => levenshtein(word, tWord) <= 2)) return true;
                        return descWords.some(dWord => levenshtein(word, dWord) <= 2);
                    });
                });

                if (visiblePacks.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400">Aucun résultat pour "${searchQuery}"</div>`;
                } else {
                    grid.innerHTML = visiblePacks.map(pack => renderPackCard(pack)).join('');
                }
                return;
            }

            // --- NOUVELLE HIÉRARCHIE : CLASSE -> MATIÈRE -> PACK ---

            // 1. CHOIX DE LA CLASSE (6e, 5e, etc)
            if (currentLevelId === null) {
                grid.innerHTML = appData.levels.map(level => {
                    const packsInLevel = visiblePacks.filter(p => p.levelId === level.id);
                    return `
                        <div onclick="goToLevelPublic('${level.id}')" class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer border-t-4 border-violet-500">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-violet-100 rounded-2xl flex items-center justify-center text-3xl">${level.icon}</div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${level.name}</h3>
                                    <p class="text-gray-500 text-sm">${packsInLevel.length} packs disponibles</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            // 2. CHOIX DE LA MATIÈRE (Maths, Espagnol, etc)
            else if (currentSubjectId === null) {
                const level = appData.levels.find(l => l.id === currentLevelId);
                const packsInLevel = visiblePacks.filter(p => p.levelId === currentLevelId);

                // On ne montre que les matières qui ont des packs pour ce niveau
                const subjectsWithPacks = appData.subjects.filter(subject =>
                    packsInLevel.some(p => p.subjectId === subject.id)
                );

                let html = `
                    <div class="col-span-full mb-4 flex items-center gap-4">
                        <button onclick="currentLevelId = null; renderPacksGrid();" class="flex items-center gap-2 px-4 py-2 bg-white text-violet-600 rounded-xl shadow-sm hover:shadow-md transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Retour aux niveaux
                        </button>
                        <h2 class="text-xl font-bold text-gray-700">${level.icon} Classe de ${level.name}</h2>
                    </div>
                `;

                if (subjectsWithPacks.length === 0) {
                    html += `<div class="col-span-full text-center py-12 text-gray-400">Aucun contenu disponible pour ce niveau.</div>`;
                } else {
                    html += subjectsWithPacks.map(subject => `
                        <div onclick="goToSubjectPublic(${subject.id})" class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer border-t-4 border-violet-400">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-violet-50 rounded-2xl flex items-center justify-center text-3xl">${subject.icon || '📁'}</div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${subject.name}</h3>
                                    <p class="text-gray-500 text-sm">${packsInLevel.filter(p => p.subjectId === subject.id).length} packs</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                grid.innerHTML = html;
            }
            // 3. AFFICHAGE DES PACKS
            else {
                const level = appData.levels.find(l => l.id === currentLevelId);
                const subject = appData.subjects.find(s => s.id === currentSubjectId);
                const packsToShow = visiblePacks.filter(p => p.levelId === currentLevelId && p.subjectId === currentSubjectId);

                let html = `
                    <div class="col-span-full mb-4 flex items-center gap-4">
                        <button onclick="currentSubjectId = null; renderPacksGrid();" class="flex items-center gap-2 px-4 py-2 bg-white text-violet-600 rounded-xl shadow-sm hover:shadow-md transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Retour à ${level.name}
                        </button>
                        <h2 class="text-xl font-bold text-gray-700">${subject.icon} ${subject.name} (${level.name})</h2>
                    </div>
                `;

                if (packsToShow.length === 0) {
                    html += `<div class="col-span-full text-center py-12 text-gray-400">Aucun pack pour cette matière à ce niveau.</div>`;
                } else {
                    html += packsToShow.map(pack => renderPackCard(pack)).join('');
                }
                grid.innerHTML = html;
            }
        }

        function goToLevelPublic(id) {
            currentLevelId = id;
            currentSubjectId = null;
            renderPacksGrid();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToSubjectPublic(id) {
            currentSubjectId = id;
            renderPacksGrid();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderPackCard(pack) {
            const subject = appData.subjects.find(s => s.id === pack.subjectId);
            return `
                <div onclick="startRevision(${pack.id})" class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-14 h-14 bg-gradient-to-br from-violet-100 to-violet-200 rounded-2xl flex items-center justify-center text-2xl">${pack.icon || '📚'}</div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="px-3 py-1 bg-violet-100 text-violet-600 rounded-full text-xs font-medium">${pack.cards.length} cartes</span>
                            <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">${subject ? subject.name : 'Divers'}</span>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${pack.title}</h3>
                    <p class="text-gray-500 text-sm line-clamp-2">${pack.description}</p>
                </div>
            `;
        }

        function renderPreviewPacksGrid() {
            const grid = document.getElementById('preview-packs-grid');
            const publishedPacks = appData.packs.filter(pack => pack.published !== false);

            // 1. CHOIX DU NIVEAU
            if (currentLevelId === null) {
                grid.innerHTML = appData.levels.map(level => `
                    <div onclick="currentLevelId = '${level.id}'; renderPreviewPacksGrid();" class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer border-t-4 border-violet-500">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-violet-100 rounded-2xl flex items-center justify-center text-3xl">${level.icon}</div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${level.name}</h3>
                                <p class="text-gray-500 text-sm">${publishedPacks.filter(p => p.levelId === level.id).length} packs publiés</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            // 2. CHOIX DE LA MATIÈRE
            else if (currentSubjectId === null) {
                const level = appData.levels.find(l => l.id === currentLevelId);
                const packsInLevel = publishedPacks.filter(p => p.levelId === currentLevelId);
                const subjectsWithPacks = appData.subjects.filter(s => packsInLevel.some(p => p.subjectId === s.id));

                let html = `
                    <div class="col-span-full mb-4 flex items-center gap-4">
                        <button onclick="currentLevelId = null; renderPreviewPacksGrid();" class="flex items-center gap-2 px-4 py-2 bg-white text-violet-600 rounded-xl shadow-sm hover:shadow-md transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Retour
                        </button>
                        <h2 class="text-xl font-bold text-gray-700">Preview: ${level.name}</h2>
                    </div>
                `;

                if (subjectsWithPacks.length === 0) {
                    html += `<div class="col-span-full text-center py-10 text-gray-400">Aucune matière avec du contenu.</div>`;
                } else {
                    html += subjectsWithPacks.map(subject => `
                        <div onclick="currentSubjectId = ${subject.id}; renderPreviewPacksGrid();" class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer border-t-4 border-violet-400">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-violet-50 rounded-xl flex items-center justify-center text-2xl">${subject.icon || '📁'}</div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${subject.name}</h3>
                                    <p class="text-gray-500 text-sm">${packsInLevel.filter(p => p.subjectId === subject.id).length} packs</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                grid.innerHTML = html;
            }
            // 3. CHOIX DU PACK
            else {
                const level = appData.levels.find(l => l.id === currentLevelId);
                const subject = appData.subjects.find(s => s.id === currentSubjectId);
                const packsToShow = publishedPacks.filter(p => p.levelId === currentLevelId && p.subjectId === currentSubjectId);

                let html = `
                    <div class="col-span-full mb-4 flex items-center gap-4">
                        <button onclick="currentSubjectId = null; renderPreviewPacksGrid();" class="flex items-center gap-2 px-4 py-2 bg-white text-violet-600 rounded-xl shadow-sm hover:shadow-md transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Retour à ${level.name}
                        </button>
                        <h2 class="text-xl font-bold text-gray-700">Packs: ${subject.name}</h2>
                    </div>
                `;

                if (packsToShow.length === 0) {
                    html += `<div class="col-span-full text-center py-10 text-gray-400">Rien à voir ici.</div>`;
                } else {
                    html += packsToShow.map(pack => `
                        <div onclick="startRevision(${pack.id}, true)" class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-violet-100 to-violet-200 rounded-2xl flex items-center justify-center text-2xl">${pack.icon || '📚'}</div>
                                <span class="px-3 py-1 bg-violet-100 text-violet-600 rounded-full text-sm font-medium">${pack.cards.length} cartes</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">${pack.title}</h3>
                            <p class="text-gray-500 text-sm">${pack.description}</p>
                        </div>
                    `).join('');
                }
                grid.innerHTML = html;
            }
        }

        // REVISION MODE
        function startRevision(packId, fromAdmin = false) {
            currentPackId = packId;
            currentCardIndex = 0;
            isAdminPreview = fromAdmin;

            const pack = appData.packs.find(p => p.id === packId);
            if (!pack || pack.cards.length === 0) {
                showToast('Ce pack ne contient aucune carte', 'error');
                return;
            }

            document.getElementById('revision-pack-title').textContent = pack.title;
            showPage('revision-page');
            updateRevisionCard();
        }

        function updateRevisionCard() {
            const pack = appData.packs.find(p => p.id === currentPackId);
            const card = pack.cards[currentCardIndex];

            document.getElementById('card-question').textContent = card.question;
            document.getElementById('card-answer').textContent = card.answer;
            document.getElementById('flashcard').classList.remove('flipped');

            const total = pack.cards.length;
            const current = currentCardIndex + 1;
            const percent = Math.round((current / total) * 100);

            document.getElementById('progress-text').textContent = `${current} / ${total}`;
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }

        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function nextCard() {
            const pack = appData.packs.find(p => p.id === currentPackId);
            currentCardIndex = (currentCardIndex + 1) % pack.cards.length;
            updateRevisionCard();
        }

        function prevCard() {
            const pack = appData.packs.find(p => p.id === currentPackId);
            currentCardIndex = (currentCardIndex - 1 + pack.cards.length) % pack.cards.length;
            updateRevisionCard();
        }

        function resetCard() {
            currentCardIndex = 0;
            updateRevisionCard();
        }

        function exitRevision() {
            if (isAdminPreview) showPage('preview-packs-page');
            else showPage('home-page');
            isAdminPreview = false;
        }

        // LOGIN & REGISTER
        function handleLogin(event) {
            event.preventDefault();

            const nom = document.getElementById('login-nom').value.trim();
            const prenom = document.getElementById('login-prenom').value.trim();
            const password = document.getElementById('login-password').value;

            const user = appData.users.find(u =>
                u.nom.toLowerCase() === nom.toLowerCase() &&
                u.prenom.toLowerCase() === prenom.toLowerCase() &&
                u.password === password
            );

            if (user) {
                currentUser = user;
                user.lastLogin = new Date().toISOString();
                localStorage.setItem('camcards_v2_user_id', user.id);
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('login-form').reset();

                // Role-based redirect
                updateHomeHeader();
                if (user.role === 'admin') {
                    showPage('dashboard-page');
                    showToast('Connexion réussie !');
                } else {
                    showPage('home-page');
                    showToast('Bienvenue ' + user.prenom + ' !');
                }

                checkWelcomeModal();
                saveData();
            } else {
                document.getElementById('login-error-text').textContent = 'Identifiants incorrects';
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function handleRegister(event) {
            event.preventDefault();

            const nom = document.getElementById('register-nom').value.trim();
            const prenom = document.getElementById('register-prenom').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;

            if (password !== passwordConfirm) {
                document.getElementById('register-error-text').textContent = 'Les mots de passe ne correspondent pas';
                document.getElementById('register-error').classList.remove('hidden');
                return;
            }

            const exists = appData.users.some(u =>
                u.nom.toLowerCase() === nom.toLowerCase() &&
                u.prenom.toLowerCase() === prenom.toLowerCase()
            );

            if (exists) {
                document.getElementById('register-error-text').textContent = 'Un compte avec ce nom et prénom existe déjà';
                document.getElementById('register-error').classList.remove('hidden');
                return;
            }

            const newUser = {
                id: Math.max(...appData.users.map(u => u.id), 0) + 1,
                nom,
                prenom,
                password,
                role: 'user',  // New users are regular users
                hasSeenWelcome: false,
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            };

            appData.users.push(newUser);
            currentUser = newUser;
            localStorage.setItem('camcards_v2_user_id', newUser.id);
            saveData();

            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-form').reset();

            updateHomeHeader();
            showToast('Compte créé avec succès ! Bienvenue ' + prenom + ' !');
            showPage('home-page');
            checkWelcomeModal();
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('camcards_v2_user_id');
            updateHomeHeader();
            showPage('home-page');
            showToast('Déconnexion réussie');
            document.getElementById('welcome-modal').classList.add('hidden');
        }

        function checkWelcomeModal() {
            if (currentUser && currentUser.hasSeenWelcome === false) {
                document.getElementById('welcome-modal').classList.remove('hidden');
            }
        }

        function closeWelcomeModal() {
            if (currentUser) {
                currentUser.hasSeenWelcome = true;
                saveData();
            }
            document.getElementById('welcome-modal').classList.add('hidden');
        }

        function updateHomeHeader() {
            const headerSection = document.getElementById('user-header-section');
            if (!headerSection) return;

            if (currentUser) {
                headerSection.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="hidden sm:block text-right">
                            <p class="text-sm font-bold text-gray-800">${currentUser.prenom} ${currentUser.nom}</p>
                            <p class="text-xs text-gray-500">${currentUser.role === 'admin' ? 'Administrateur' : 'Élève'}</p>
                        </div>
                        <button onclick="handleLogout()" class="px-4 py-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-colors flex items-center gap-2" title="Déconnexion">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="hidden sm:inline">Déconnexion</span>
                        </button>
                    </div>
                `;
            } else {
                headerSection.innerHTML = `
                    <button onclick="showPage('login-page')" class="flex items-center gap-2 px-4 py-2 text-violet-600 hover:bg-violet-50 rounded-xl transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Connexion</span>
                    </button>
                `;
            }
        }

        function updateDashboard() {
            if (currentUser) {
                const welcomeMsg = document.getElementById('welcome-message');
                if (welcomeMsg) welcomeMsg.textContent = `Bienvenue, ${currentUser.prenom} !`;
            }

            // Plus de badge de demandes en attente car l'inscription est immédiate
            const badge = document.getElementById('pending-badge');
            if (badge) badge.classList.add('hidden');

            // Mise à jour des statistiques
            if (appData && appData.stats) {
                const anaTotal = document.getElementById('ana-total-visits');
                const anaOnline = document.getElementById('ana-online-users');

                if (anaOnline) anaOnline.textContent = getOnlineCount();
            }

            // Notification badge pour Communication (Feedbacks non vus)
            const commBadge = document.getElementById('comm-notif-badge');
            if (commBadge) {
                const hasNew = appData.feedback && appData.feedback.length > 0;
                commBadge.classList.toggle('hidden', !hasNew);
            }
        }

        // ADMIN MANAGEMENT
        function renderAdminsPage() {
            const usersList = document.getElementById('all-users-list');

            if (!appData.users || appData.users.length === 0) {
                usersList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <p>Aucun utilisateur</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = appData.users.map(user => {
                const isCurrentUser = currentUser && currentUser.id === user.id;
                const isAdmin = user.role === 'admin';
                const isSuperAdmin = user.superAdmin === true;

                return `
                    <div class="flex items-center justify-between p-4 ${isAdmin ? 'bg-violet-50 border-2 border-violet-200' : 'bg-gray-50'} rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 ${isAdmin ? 'bg-violet-200' : 'bg-gray-200'} rounded-full flex items-center justify-center">
                                <span class="${isAdmin ? 'text-violet-700' : 'text-gray-700'} font-bold">${user.prenom.charAt(0)}${user.nom.charAt(0)}</span>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-semibold text-gray-800">${user.prenom} ${user.nom}</p>
                                    ${user.superAdmin ? `
                                        <span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs font-medium flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                            </svg>
                                            Super Admin
                                        </span>
                                    ` : isAdmin ? `
                                        <span class="px-2 py-0.5 bg-violet-100 text-violet-700 rounded-full text-xs font-medium flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                            </svg>
                                            Admin
                                        </span>
                                    ` : `
                                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">
                                            Utilisateur
                                        </span>
                                    `}
                                    ${isCurrentUser ? `<span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">Vous</span>` : ''}
                                </div>
                                <p class="text-sm text-gray-500">Inscrit le ${new Date(user.createdAt).toLocaleDateString('fr-FR')}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${!isCurrentUser && !isSuperAdmin ? `
                                ${isAdmin ? `
                                    <button onclick="demoteUser(${user.id})" class="flex items-center gap-1 px-3 py-2 bg-white text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 17l-4 4m0 0l-4-4m4 4V3"/>
                                        </svg>
                                        Rétrograder
                                    </button>
                                ` : `
                                    <button onclick="promoteUser(${user.id})" class="flex items-center gap-1 px-3 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7l4-4m0 0l4 4m-4-4v18"/>
                                        </svg>
                                        Promouvoir Admin
                                    </button>
                                `}
                                <button onclick="deleteUser(${user.id})" class="flex items-center gap-1 px-3 py-2 bg-white text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Supprimer
                                </button>
                            ` : isSuperAdmin && !isCurrentUser ? `
                                <span class="px-3 py-2 text-amber-600 text-sm font-medium flex items-center gap-1 bg-amber-50 rounded-lg border border-amber-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                    </svg>
                                    Compte Protégé
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function promoteUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (user && confirm(`Promouvoir ${user.prenom} ${user.nom} en administrateur ?`)) {
                user.role = 'admin';
                saveData();
                renderAdminsPage();
                showToast(`${user.prenom} ${user.nom} est maintenant administrateur`);
            }
        }

        function demoteUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (user && user.superAdmin) {
                showToast("Impossible de rétrograder cet administrateur protégé", "error");
                return;
            }
            if (user && confirm(`Rétrograder ${user.prenom} ${user.nom} en utilisateur simple ?`)) {
                user.role = 'user';
                saveData();
                renderAdminsPage();
                showToast(`${user.prenom} ${user.nom} est maintenant utilisateur simple`);

                // If user is currently logged in, force logout and redirect
                if (currentUser && currentUser.id === userId) {
                    handleLogout();
                }
            }
        }

        function deleteUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (user && user.superAdmin) {
                showToast("Impossible de supprimer cet administrateur protégé", "error");
                return;
            }
            if (user && confirm(`Supprimer définitivement ${user.prenom} ${user.nom} ?`)) {
                appData.users = appData.users.filter(u => u.id !== userId);
                saveData();
                renderAdminsPage();
                updateDashboard();
                showToast(`${user.prenom} ${user.nom} a été supprimé`);
            }
        }

        // --- CENTRE DE COMMUNICATION ---
        function renderCommHub() {
            renderCommAnnouncements();
            renderCommAdminNotes();
            renderCommFeedback();
        }

        // 📣 ANNONCES
        function postAnnouncement() {
            const textArea = document.getElementById('comm-ann-text');
            const text = textArea.value.trim();
            if (!text) return;

            const newAnn = {
                id: Date.now(),
                text: text,
                author: currentUser.prenom + ' ' + currentUser.nom,
                date: new Date().toISOString()
            };

            appData.announcements.unshift(newAnn);
            saveData();
            textArea.value = '';
            renderCommAnnouncements();
            renderAnnouncements();
            showToast('Annonce publiée !');
        }

        function deleteAnnouncement(id) {
            appData.announcements = appData.announcements.filter(a => a.id !== id);
            saveData();
            renderCommAnnouncements();
            renderAnnouncements();
        }

        function renderCommAnnouncements() {
            const list = document.getElementById('comm-ann-list');
            if (!list) return;
            list.innerHTML = appData.announcements.map(ann => `
                <div class="p-3 bg-violet-50 rounded-xl border border-violet-100 relative group">
                    <p class="text-sm text-gray-800 pr-6">${ann.text}</p>
                    <p class="text-[10px] text-violet-400 mt-2 font-bold uppercase tracking-wider">${ann.author} • ${new Date(ann.date).toLocaleDateString()}</p>
                    <button onclick="deleteAnnouncement(${ann.id})" class="absolute top-2 right-2 text-red-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            `).join('') || '<p class="text-center text-gray-400 text-sm">Aucune annonce active</p>';
        }

        function renderAnnouncements() {
            const banner = document.getElementById('announcement-banner');
            const content = document.getElementById('announcement-content');
            if (!banner || !content) return;

            if (appData.announcements && appData.announcements.length > 0) {
                const latest = appData.announcements[0];
                content.textContent = `📣 ${latest.text}`;
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        }

        function closeAnnouncement() {
            document.getElementById('announcement-banner').classList.add('hidden');
        }

        // 💬 ADMIN NOTES
        function postAdminNote() {
            const textArea = document.getElementById('comm-admin-note');
            const text = textArea.value.trim();
            if (!text) return;

            const newNote = {
                id: Date.now(),
                text: text,
                author: currentUser.prenom + ' ' + currentUser.nom,
                date: new Date().toISOString()
            };

            appData.admin_notes.unshift(newNote);
            if (appData.admin_notes.length > 50) appData.admin_notes.pop(); // Limite
            saveData(true);
            textArea.value = '';
            renderCommAdminNotes();
        }

        function deleteAdminNote(id) {
            appData.admin_notes = appData.admin_notes.filter(n => n.id !== id);
            saveData(true);
            renderCommAdminNotes();
        }

        function renderCommAdminNotes() {
            const list = document.getElementById('comm-admin-notes-list');
            if (!list) return;
            list.innerHTML = appData.admin_notes.map(note => `
                <div class="p-3 bg-indigo-50 rounded-xl border border-indigo-100 relative group">
                    <p class="text-sm text-gray-800 pr-6">${note.text}</p>
                    <p class="text-[10px] text-indigo-400 mt-2 font-bold uppercase tracking-wider">${note.author} • Il y a ${Math.round((Date.now() - new Date(note.date)) / 60000)} min</p>
                    <button onclick="deleteAdminNote(${note.id})" class="absolute top-2 right-2 text-red-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            `).join('') || '<p class="text-center text-gray-400 text-sm">Pas encore de notes</p>';
        }

        // 📩 FEEDBACK
        function openFeedbackModal() {
            document.getElementById('feedback-modal').classList.remove('hidden');
            document.getElementById('feedback-text').focus();
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.add('hidden');
            document.getElementById('feedback-text').value = '';
        }

        function sendFeedback() {
            const text = document.getElementById('feedback-text').value.trim();
            if (!text) return;

            const newFeedback = {
                id: Date.now(),
                text: text,
                user: currentUser ? (currentUser.prenom + ' ' + currentUser.nom) : 'Éélève Anonyme',
                date: new Date().toISOString()
            };

            appData.feedback.unshift(newFeedback);
            if (appData.feedback.length > 100) appData.feedback.pop();
            saveData(true);
            closeFeedbackModal();
            showToast('Message envoyé ! Merci pour ton retour.');
        }

        function deleteFeedback(id) {
            appData.feedback = appData.feedback.filter(f => f.id !== id);
            saveData(true);
            renderCommFeedback();
            updateDashboard();
        }

        function renderCommFeedback() {
            const list = document.getElementById('comm-feedback-list');
            if (!list) return;
            list.innerHTML = appData.feedback.map(f => `
                <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 relative group">
                    <p class="text-sm text-gray-800 mb-3">${f.text}</p>
                    <div class="flex items-center justify-between">
                        <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">De: ${f.user} • ${new Date(f.date).toLocaleDateString()}</p>
                        <button onclick="deleteFeedback(${f.id})" class="text-xs text-red-500 font-bold hover:underline opacity-0 group-hover:opacity-100 transition-opacity">Supprimer</button>
                    </div>
                </div>
            `).join('') || '<p class="text-center text-gray-400 text-sm py-10">Aucun nouveau retour</p>';
        }

        // MANAGE PACKS
        function renderManagePacksList() {
            const list = document.getElementById('manage-packs-list');
            const header = document.querySelector('#manage-packs-page header h2');
            const btnsContainer = document.querySelector('#manage-packs-page main .flex.flex-wrap');

            // --- NOUVEAU : NIVEAUX -> MATIÈRES -> PACKS ---

            // 1. CHOIX DU NIVEAU
            if (currentLevelId === null) {
                header.textContent = "Gérer les Niveaux";
                btnsContainer.innerHTML = `
                    <button onclick="addNewLevel()" class="flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Ajouter un niveau
                    </button>
                    <button onclick="toggleDeleteMode()" class="flex items-center gap-2 px-4 py-2 ${deleteMode ? 'bg-red-100 text-red-600' : 'bg-white text-red-600'} border border-red-200 rounded-xl hover:bg-red-50 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        Supprimer des niveaux
                    </button>
                    <button onclick="deleteSelectedLevels()" class="${deleteMode ? 'flex' : 'hidden'} items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        Confirmer la suppression
                    </button>
                `;

                list.innerHTML = appData.levels.map(level => `
                    <div class="bg-white rounded-xl shadow-md p-5 flex items-center gap-4 border-l-4 border-violet-500">
                        ${deleteMode ? `<input type="checkbox" class="level-checkbox w-5 h-5 text-violet-600 rounded cursor-pointer" data-id="${level.id}">` : ''}
                        <div onclick="${deleteMode ? '' : `currentLevelId = '${level.id}'; renderManagePacksList();`}" class="${deleteMode ? '' : 'cursor-pointer'} flex-1 flex items-center gap-4">
                            <div class="w-14 h-14 bg-violet-100 rounded-xl flex items-center justify-center text-2xl flex-shrink-0">${level.icon}</div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-lg text-gray-800">${level.name}</h4>
                                <p class="text-gray-500 text-sm">${appData.packs.filter(p => p.levelId === level.id).length} packs trouvés</p>
                            </div>
                        </div>
                        ${!deleteMode ? `
                            <div class="flex items-center gap-2">
                                <button onclick="editLevel('${level.id}')" class="p-2 hover:bg-violet-100 rounded-xl transition-colors text-violet-600" title="Modifier">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                                <button onclick="currentLevelId = '${level.id}'; renderManagePacksList();" class="px-4 py-2 bg-violet-50 text-violet-600 rounded-lg font-medium hover:bg-violet-100">Ouvrir</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }
            // 2. CHOIX DE LA MATIÈRE
            else if (currentSubjectId === null) {
                const level = appData.levels.find(l => l.id === currentLevelId);
                header.textContent = `Matières (${level.name})`;
                btnsContainer.innerHTML = `
                    <button onclick="addNewSubject()" class="flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Ajouter une matière
                    </button>
                    <button onclick="toggleDeleteMode()" class="flex items-center gap-2 px-4 py-2 ${deleteMode ? 'bg-red-100 text-red-600' : 'bg-white text-red-600'} border border-red-200 rounded-xl hover:bg-red-50 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        Supprimer des matières
                    </button>
                    <button onclick="deleteSelectedSubjectFolders()" class="${deleteMode ? 'flex' : 'hidden'} items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        Confirmer la suppression
                    </button>
                `;

                const subjectsInLevel = appData.subjects.filter(s => s.levelId === currentLevelId);

                list.innerHTML = subjectsInLevel.map(subject => {
                    const packCount = appData.packs.filter(p => p.subjectId === subject.id && p.levelId === currentLevelId).length;
                    return `
                    <div class="bg-white rounded-xl shadow-md p-5 flex items-center gap-4 border-l-4 border-violet-400">
                        ${deleteMode ? `<input type="checkbox" class="subject-checkbox w-5 h-5 text-violet-600 rounded cursor-pointer" data-id="${subject.id}">` : ''}
                        <div onclick="${deleteMode ? '' : `goToSubject(${subject.id})`}" class="${deleteMode ? '' : 'cursor-pointer'} flex-1 flex items-center gap-4">
                            <div class="w-14 h-14 bg-violet-100 rounded-xl flex items-center justify-center text-2xl flex-shrink-0">${subject.icon || '📁'}</div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-lg text-gray-800 truncate">${subject.name}</h4>
                                <p class="text-gray-500 text-sm">${packCount} pack(s) à ce niveau</p>
                            </div>
                        </div>
                        ${!deleteMode ? `
                            <div class="flex items-center gap-2">
                                <button onclick="openSubjectMoveModal(${subject.id})" class="p-2 hover:bg-amber-100 rounded-xl transition-colors text-amber-600" title="Transférer vers un autre niveau">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                                </button>
                                <button onclick="editSubject(${subject.id})" class="p-2 hover:bg-violet-100 rounded-xl transition-colors text-violet-600" title="Modifier">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                                <button onclick="goToSubject(${subject.id})" class="px-4 py-2 bg-violet-50 text-violet-600 rounded-lg font-medium hover:bg-violet-100">Ouvrir</button>
                            </div>
                        ` : ''}
                    </div>
                `}).join('');
            }
            // 3. LISTE DES PACKS
            else {
                const subject = appData.subjects.find(s => s.id === currentSubjectId);
                const level = appData.levels.find(l => l.id === currentLevelId);
                header.innerHTML = `
                    <div class="flex items-center gap-2">
                        <button onclick="currentSubjectId = null; renderManagePacksList();" class="p-1 hover:bg-violet-100 rounded text-violet-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <span>${subject.name} - ${level.name}</span>
                    </div>`;

                btnsContainer.innerHTML = `
                    <button onclick="addNewPack()" class="flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-xl hover:bg-violet-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        Nouveau pack
                    </button>
                    <button onclick="toggleMoveMode()" class="flex items-center gap-2 px-4 py-2 ${moveMode ? 'bg-amber-100 text-amber-600' : 'bg-white text-blue-600'} border border-blue-200 rounded-xl hover:bg-blue-50 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                        Transférer
                    </button>
                    <button onclick="toggleDeleteMode()" class="flex items-center gap-2 px-4 py-2 ${deleteMode ? 'bg-red-100 text-red-600' : 'bg-white text-red-600'} border border-red-200 rounded-xl hover:bg-red-50 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        Retirer
                    </button>
                    <button onclick="prepareBulkMove()" class="${moveMode ? 'flex' : 'hidden'} items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        Confirmer le transfert
                    </button>
                    <button onclick="deleteSelectedPacks()" class="${deleteMode ? 'flex' : 'hidden'} items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        Confirmer la suppression
                    </button>
                `;

                const filteredPacks = appData.packs.filter(p => p.subjectId === currentSubjectId && p.levelId === currentLevelId);

                if (filteredPacks.length === 0) {
                    list.innerHTML = '<p class="text-center py-10 text-gray-400">Aucun pack ici.</p>';
                } else {
                    list.innerHTML = filteredPacks.map(pack => {
                        const isPublished = pack.published === true;
                        return `
                        <div class="bg-white rounded-xl shadow-md p-4 flex items-center gap-4 ${!isPublished ? 'border-l-4 border-amber-400' : 'border-l-4 border-green-400'}">
                            ${(deleteMode || moveMode) ? `<input type="checkbox" class="pack-checkbox w-5 h-5 text-violet-600 rounded" data-id="${pack.id}">` : ''}
                            <div class="w-12 h-12 bg-gradient-to-br from-violet-100 to-violet-200 rounded-xl flex items-center justify-center text-xl flex-shrink-0">${pack.icon || '📚'}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-semibold text-gray-800 truncate">${pack.title}</h4>
                                    <span class="px-2 py-0.5 ${isPublished ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'} rounded-full text-xs font-medium flex-shrink-0">${isPublished ? 'Publié' : 'Brouillon'}</span>
                                </div>
                                <p class="text-gray-500 text-sm truncate">${pack.description}</p>
                            </div>
                            <span class="px-3 py-1 bg-violet-100 text-violet-600 rounded-full text-sm font-medium flex-shrink-0">${pack.cards.length} cartes</span>
                            ${(!deleteMode && !moveMode) ? `
                                <div class="flex items-center gap-2">
                                    <button onclick="togglePublishPack(${pack.id})" class="toggle-switch ${isPublished ? 'active' : ''}" title="${isPublished ? 'Désactiver' : 'Activer'}"></button>
                                    <button onclick="editPack(${pack.id})" class="p-2 hover:bg-violet-100 rounded-xl transition-colors text-violet-600" title="Editer">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('');
                }
            }
        }

        function goToSubject(id) {
            currentSubjectId = id;
            deleteMode = false;
            moveMode = false;
            renderManagePacksList();
        }

        let pendingMoveIds = [];

        function prepareBulkMove() {
            const checkboxes = document.querySelectorAll('.pack-checkbox:checked');
            const idsToMove = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));

            if (idsToMove.length === 0) {
                showToast('Sélectionnez au moins un pack', 'error');
                return;
            }

            openMoveModal(idsToMove);
        }

        function toggleMoveMode() {
            moveMode = !moveMode;
            if (moveMode) deleteMode = false;
            renderManagePacksList();
        }

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            if (deleteMode) moveMode = false;
            renderManagePacksList();
        }

        function openMoveModal(packIds) {
            pendingMoveIds = packIds;
            pendingMoveSubjectId = null;
            const modal = document.getElementById('move-modal');
            const title = modal.querySelector('h3');
            const list = document.getElementById('move-subjects-list');

            title.textContent = "Déplacer dans une matière...";

            // Lister les autres matières
            const otherSubjects = appData.subjects.filter(s => s.id !== currentSubjectId);

            if (otherSubjects.length === 0) {
                showToast("Aucune autre matière disponible pour le déplacement.", "info");
                return;
            }

            list.innerHTML = otherSubjects.map(s => `
                <button onclick="confirmMove(${s.id})" class="w-full flex items-center gap-3 p-3 hover:bg-violet-50 rounded-xl transition-all border border-transparent hover:border-violet-200">
                    <span class="text-2xl">${s.icon || '📁'}</span>
                    <span class="font-semibold text-gray-700">${s.name}</span>
                </button>
            `).join('');

            modal.classList.remove('hidden');
        }

        function openSubjectMoveModal(subjectId) {
            pendingMoveSubjectId = subjectId;
            pendingMoveIds = [];
            const modal = document.getElementById('move-modal');
            const title = modal.querySelector('h3');
            const list = document.getElementById('move-subjects-list');
            const subject = appData.subjects.find(s => s.id === subjectId);

            title.textContent = `Transférer "${subject.name}" vers...`;

            // Lister les autres niveaux
            const otherLevels = appData.levels.filter(l => l.id !== currentLevelId);

            list.innerHTML = otherLevels.map(l => `
                <button onclick="confirmLevelMove('${l.id}')" class="w-full flex items-center gap-3 p-3 hover:bg-violet-50 rounded-xl transition-all border border-transparent hover:border-violet-200">
                    <span class="text-2xl">${l.icon}</span>
                    <span class="font-semibold text-gray-700">${l.name}</span>
                </button>
            `).join('');

            modal.classList.remove('hidden');
        }

        function closeMoveModal() {
            document.getElementById('move-modal').classList.add('hidden');
            pendingMoveIds = [];
            pendingMoveSubjectId = null;
        }

        function confirmLevelMove(destLevelId) {
            const level = appData.levels.find(l => l.id === destLevelId);
            const subject = appData.subjects.find(s => s.id === pendingMoveSubjectId);

            // On déplace tous les packs de cette matière ET de ce niveau vers le nouveau niveau
            const packsToMove = appData.packs.filter(p => p.subjectId === pendingMoveSubjectId && p.levelId === currentLevelId);

            if (packsToMove.length === 0) {
                showToast("Aucun contenu à déplacer pour cette matière dans ce niveau.", "info");
                closeMoveModal();
                return;
            }

            packsToMove.forEach(pack => {
                pack.levelId = destLevelId;
            });

            saveData();
            closeMoveModal();
            renderManagePacksList();
            showToast(`${packsToMove.length} pack(s) transférés vers ${level.name}`);
        }

        function confirmMove(destSubjectId) {
            const subject = appData.subjects.find(s => s.id === destSubjectId);

            appData.packs.forEach(pack => {
                if (pendingMoveIds.includes(pack.id)) {
                    pack.subjectId = destSubjectId;
                }
            });

            saveData();
            closeMoveModal();
            moveMode = false;
            renderManagePacksList();
            showToast(`${pendingMoveIds.length} pack(s) déplacé(s) vers "${subject.name}"`);
        }

        function addNewLevel() {
            const name = prompt("Nom du niveau (ex: 2nde, Terminale) :");
            if (!name) return;
            const icon = prompt("Emoji / Icône (ex: 🎓) :", "📁");
            const id = name.toLowerCase().replace(/\s+/g, '-');

            if (appData.levels.some(l => l.id === id)) {
                showToast("Ce niveau existe déjà", "error");
                return;
            }

            appData.levels.push({ id, name, icon });
            saveData();
            renderManagePacksList();
            showToast(`Niveau "${name}" créé`);
        }

        function editLevel(levelId) {
            const level = appData.levels.find(l => l.id === levelId);
            const newName = prompt("Nouveau nom :", level.name);
            if (!newName) return;
            const newIcon = prompt("Nouvel icône :", level.icon);

            level.name = newName;
            level.icon = newIcon;
            saveData();
            renderManagePacksList();
        }

        function deleteSelectedLevels() {
            const checkboxes = document.querySelectorAll('.level-checkbox:checked');
            const idsToDelete = Array.from(checkboxes).map(cb => cb.dataset.id);

            if (idsToDelete.length === 0) {
                showToast('Sélectionnez au moins un niveau', 'error');
                return;
            }

            if (!confirm(`Supprimer ${idsToDelete.length} niveau(x) ? Cela supprimera TOUTES les matières et TOUS les packs associés !`)) return;

            // Delete packs belonging to these levels
            appData.packs = appData.packs.filter(p => !idsToDelete.includes(p.levelId));
            // Delete levels
            appData.levels = appData.levels.filter(l => !idsToDelete.includes(l.id));

            saveData();
            deleteMode = false;
            renderManagePacksList();
            showToast(`Niveau(x) supprimé(s)`);
        }

        function addNewSubject() {
            const name = prompt("Nom de la matière :");
            if (!name) return;
            const icon = prompt("Emoji / Icône (optionnel) :", "📁");

            const newId = Math.max(...appData.subjects.map(s => s.id), 0) + 1;
            appData.subjects.push({
                id: newId,
                name,
                icon,
                levelId: currentLevelId
            });
            saveData();
            renderManagePacksList();
            showToast(`Matière "${name}" créée`);
        }

        function editSubject(subjectId) {
            const subject = appData.subjects.find(s => s.id === subjectId);
            const newName = prompt("Nouveau nom :", subject.name);
            if (!newName) return;
            const newIcon = prompt("Nouvel icône :", subject.icon);

            subject.name = newName;
            subject.icon = newIcon;
            saveData();
            renderManagePacksList();
        }

        function deleteSelectedSubjectFolders() {
            const checkboxes = document.querySelectorAll('.subject-checkbox:checked');
            const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));

            if (idsToDelete.length === 0) {
                showToast('Sélectionnez au moins une matière', 'error');
                return;
            }

            if (!confirm(`Supprimer ${idsToDelete.length} matière(s) ? Cela supprimera TOUS les packs contenus dedans !`)) return;

            // Delete packs belonging to these subjects
            appData.packs = appData.packs.filter(p => !idsToDelete.includes(p.subjectId));
            // Delete subjects
            appData.subjects = appData.subjects.filter(s => !idsToDelete.includes(s.id));

            saveData();
            deleteMode = false;
            renderManagePacksList();
            showToast(`Matière(s) supprimée(s)`);
        }

        function togglePublishPack(packId) {
            const pack = appData.packs.find(p => p.id === packId);
            if (pack) {
                pack.published = !pack.published;
                saveData();
                renderManagePacksList();
                showToast(pack.published ? `"${pack.title}" est maintenant en ligne` : `"${pack.title}" est maintenant hors ligne`, pack.published ? 'success' : 'info');
            }
        }

        function addNewPack() {
            if (currentSubjectId === null || currentLevelId === null) {
                showToast("Veuillez d'abord ouvrir une matière", "info");
                return;
            }
            const newId = Math.max(...appData.packs.map(p => p.id), 0) + 1;
            const newPack = {
                id: newId,
                levelId: currentLevelId,
                subjectId: currentSubjectId, // Assignation au dossier actuel
                title: "Nouveau Pack",
                description: "Description du pack",
                icon: "📚",
                published: false,
                cards: []
            };
            appData.packs.push(newPack);
            saveData();
            editPack(newId);
            showToast('Nouveau pack créé (brouillon)', 'info');
        }



        function deleteSelectedPacks() {
            const checkboxes = document.querySelectorAll('.pack-checkbox:checked');
            const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));

            if (idsToDelete.length === 0) {
                showToast('Sélectionnez au moins un pack', 'error');
                return;
            }

            if (!confirm(`Supprimer ${idsToDelete.length} pack(s) ?`)) return;

            appData.packs = appData.packs.filter(p => !idsToDelete.includes(p.id));
            saveData();
            deleteMode = false;
            renderManagePacksList();
            showToast(`${idsToDelete.length} pack(s) supprimé(s)`);
        }

        // EDIT PACK
        function editPack(packId) {
            editingPackId = packId;
            hasUnsavedChanges = false;
            const pack = appData.packs.find(p => p.id === packId);

            document.getElementById('edit-pack-title').value = pack.title;
            document.getElementById('edit-pack-desc').value = pack.description;
            document.getElementById('edit-pack-icon').value = pack.icon || '📚';

            // Peupler le sélecteur de niveau
            const levelSelect = document.getElementById('edit-pack-level');
            levelSelect.innerHTML = appData.levels.map(l => `
                <option value="${l.id}" ${l.id === pack.levelId ? 'selected' : ''}>${l.name}</option>
            `).join('');

            // Mise à jour adaptative des matières quand on change de niveau
            levelSelect.onchange = (e) => {
                hasUnsavedChanges = true;
                const newLevelId = e.target.value;
                const filteredSubjects = appData.subjects.filter(s => s.levelId === newLevelId);
                const subjectSelect = document.getElementById('edit-pack-subject');
                subjectSelect.innerHTML = filteredSubjects.map(s => `
                    <option value="${s.id}">${s.name}</option>
                `).join('');
                if (filteredSubjects.length === 0) {
                    subjectSelect.innerHTML = '<option value="">Aucune matière</option>';
                }
            };

            // Peupler le sélecteur de matière (filtré par niveau du pack)
            const subjectSelect = document.getElementById('edit-pack-subject');
            const initialSubjects = appData.subjects.filter(s => s.levelId === pack.levelId);
            subjectSelect.innerHTML = initialSubjects.map(s => `
                <option value="${s.id}" ${s.id === pack.subjectId ? 'selected' : ''}>${s.name}</option>
            `).join('');

            subjectSelect.onchange = () => { hasUnsavedChanges = true; };

            editingCards = JSON.parse(JSON.stringify(pack.cards));
            renderEditCardsList();
            showPage('edit-pack-page');
        }

        function renderEditCardsList() {
            const list = document.getElementById('edit-cards-list');
            list.innerHTML = editingCards.map((card, index) => `
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-violet-600">Carte ${index + 1}</span>
                        <button onclick="deleteEditCard(${index})" class="p-2 hover:bg-red-100 rounded-xl transition-colors text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Question</label>
                            <textarea onchange="updateEditCard(${index}, 'question', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none resize-none" rows="3">${card.question}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Réponse</label>
                            <textarea onchange="updateEditCard(${index}, 'answer', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent outline-none resize-none" rows="3">${card.answer}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addCardToEdit() {
            editingCards.push({ question: "", answer: "" });
            hasUnsavedChanges = true;
            renderEditCardsList();
        }

        function deleteEditCard(index) {
            editingCards.splice(index, 1);
            hasUnsavedChanges = true;
            renderEditCardsList();
        }

        function updateEditCard(index, field, value) {
            editingCards[index][field] = value;
            hasUnsavedChanges = true;
        }

        function saveEditedPack() {
            const pack = appData.packs.find(p => p.id === editingPackId);
            pack.title = document.getElementById('edit-pack-title').value;
            pack.description = document.getElementById('edit-pack-desc').value;
            pack.icon = document.getElementById('edit-pack-icon').value || '📚';
            pack.levelId = document.getElementById('edit-pack-level').value;
            pack.subjectId = parseInt(document.getElementById('edit-pack-subject').value);
            pack.cards = editingCards.filter(c => c.question.trim() || c.answer.trim());

            saveData();
            hasUnsavedChanges = false;
            showToast('Pack enregistré avec succès !');
        }

        // IMPORT CARDS MODAL
        function openImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            document.getElementById('import-cards-text').value = '';
            document.getElementById('import-preview').classList.add('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            document.getElementById('import-cards-text').value = '';
            document.getElementById('import-cards-csv').value = '';
            document.getElementById('csv-filename').textContent = '';
            document.getElementById('import-preview').classList.add('hidden');
        }

        function handleCSVCardsImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('csv-filename').textContent = `Fichier sélectionné : ${file.name}`;

            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/);
                const cards = [];

                lines.forEach(line => {
                    if (!line.trim()) return;

                    // Détection du séparateur (virgule ou point-virgule)
                    let parts;
                    if (line.includes(';')) {
                        parts = line.split(';');
                    } else {
                        parts = line.split(',');
                    }

                    if (parts.length >= 2) {
                        const question = parts[0].trim();
                        const answer = parts[1].trim();
                        if (question && answer) {
                            cards.push({ question, answer });
                        }
                    }
                });

                if (cards.length === 0) {
                    showToast('Aucune carte détectée dans le CSV', 'error');
                    return;
                }

                // Afficher l'aperçu
                const previewList = document.getElementById('import-preview-list');
                previewList.innerHTML = cards.map((card, i) => `
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-sm"><strong>Q${i + 1}:</strong> ${card.question}</p>
                        <p class="text-sm text-gray-600"><strong>R:</strong> ${card.answer}</p>
                    </div>
                `).join('');

                document.getElementById('import-preview').classList.remove('hidden');
                document.getElementById('import-preview').dataset.cards = JSON.stringify(cards);
                showToast(`${cards.length} cartes chargées depuis le CSV`);
            };
            reader.readAsText(file);
        }

        function previewImportCards() {
            const text = document.getElementById('import-cards-text').value;
            const regex = /\("([^"]+)",\s*"([^"]+)"\)/g;
            const cards = [];
            let match;

            while ((match = regex.exec(text)) !== null) {
                cards.push({ question: match[1], answer: match[2] });
            }

            if (cards.length === 0) {
                showToast('Aucune carte détectée. Vérifiez le format.', 'error');
                return;
            }

            const previewList = document.getElementById('import-preview-list');
            previewList.innerHTML = cards.map((card, i) => `
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-sm"><strong>Q${i + 1}:</strong> ${card.question}</p>
                    <p class="text-sm text-gray-600"><strong>R:</strong> ${card.answer}</p>
                </div>
            `).join('');

            document.getElementById('import-preview').classList.remove('hidden');
            document.getElementById('import-preview').dataset.cards = JSON.stringify(cards);
        }

        function confirmImportCards() {
            const previewEl = document.getElementById('import-preview');
            if (previewEl.classList.contains('hidden')) {
                previewImportCards();
                return;
            }

            const cards = JSON.parse(previewEl.dataset.cards || '[]');
            if (cards.length === 0) {
                showToast('Aucune carte à importer', 'error');
                return;
            }

            editingCards = [...editingCards, ...cards];
            renderEditCardsList();
            closeImportModal();
            showToast(`${cards.length} carte(s) importée(s)`);
        }

        // BACKUP
        function downloadJSON() {
            // SÉCURITÉ : On n'exporte PAS les administrateurs (et leurs mots de passe !)
            const exportData = {
                subjects: appData.subjects,
                packs: appData.packs
                // Pas d'admins ici
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `camcards_v2_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Fichier téléchargé (Pack & Dossiers) !');
        }

        function showExportText() {
            const container = document.getElementById('export-text-container');
            const textarea = document.getElementById('export-text');
            container.classList.toggle('hidden');

            // SÉCURITÉ : On n'exporte PAS les administrateurs
            const exportData = {
                subjects: appData.subjects,
                packs: appData.packs
            };

            textarea.value = JSON.stringify(exportData, null, 2);
        }

        function copyExportText() {
            const textarea = document.getElementById('export-text');
            textarea.select();
            // Utilisation moderne + fallback ancien
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    showToast('Copié dans le presse-papier !');
                }).catch(() => {
                    document.execCommand('copy');
                    showToast('Copié dans le presse-papier !');
                });
            } else {
                document.execCommand('copy');
                showToast('Copié dans le presse-papier !');
            }
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('import-text').value = e.target.result;
                showToast('Fichier chargé, cliquez sur Importer');
            };
            reader.readAsText(file);
        }

        function importFromText() {
            const text = document.getElementById('import-text').value.trim();
            if (!text) {
                showToast('Collez ou chargez un JSON', 'error');
                return;
            }

            try {
                const importedData = JSON.parse(text);
                if (!importedData.packs || !Array.isArray(importedData.packs)) {
                    throw new Error('Format packs manquant');
                }

                const mode = document.querySelector('input[name="import-mode"]:checked').value;
                const subjectMapping = {}; // Old Subject ID -> Current Subject ID

                if (mode === 'replace') {
                    if (confirm("Attention: Tout le contenu actuel sera remplacé par le fichier importé.")) {
                        appData.packs = importedData.packs;
                        appData.subjects = importedData.subjects || [];
                        // On garde les admins locaux pour ne pas se bloquer dehors
                    } else {
                        return;
                    }
                } else {
                    // MODE MERGE (Additionner)

                    // 1. Gérer les matières
                    if (importedData.subjects && Array.isArray(importedData.subjects)) {
                        importedData.subjects.forEach(impSub => {
                            // Chercher si elle existe déjà par nom (plus fiable que ID)
                            let existing = appData.subjects.find(s => s.name.toLowerCase() === impSub.name.toLowerCase());
                            if (!existing) {
                                // Créer la nouvelle matière
                                const newId = Math.max(...appData.subjects.map(s => s.id), 0) + 1;
                                existing = { ...impSub, id: newId };
                                appData.subjects.push(existing);
                                console.log(`Dossier créé pendant l'import: ${existing.name}`);
                            }
                            subjectMapping[impSub.id] = existing.id;
                        });
                    }

                    // 2. Gérer les packs
                    importedData.packs.forEach(newPack => {
                        // Réassocier à la bonne matière si possible
                        if (newPack.subjectId && subjectMapping[newPack.subjectId]) {
                            newPack.subjectId = subjectMapping[newPack.subjectId];
                        }

                        // Éviter les doublons exacts
                        const isDuplicate = appData.packs.some(existingPack =>
                            existingPack.title === newPack.title &&
                            JSON.stringify(existingPack.cards) === JSON.stringify(newPack.cards)
                        );

                        if (!isDuplicate) {
                            const newId = Math.max(...appData.packs.map(p => p.id), 0) + 1;
                            newPack.id = newId;
                            appData.packs.push(newPack);
                        }
                    });
                }

                // Appliquer l'intégrité (re-migration auto si besoin)
                ensureDataIntegrity();

                saveData();
                document.getElementById('import-text').value = '';
                document.getElementById('import-file').value = '';
                showToast('Import réussi !');
                renderPacksGrid();
            } catch (error) {
                console.error("Import error:", error);
                showToast(`Erreur d'import: ${error.message}`, 'error');
            }
        }

        // PDF GENERATION
        function downloadCardsPDF() {
            const pack = appData.packs.find(p => p.id === currentPackId);
            if (!pack || pack.cards.length === 0) {
                showToast('Aucune carte à exporter', 'error');
                return;
            }

            const btn = document.getElementById('download-pdf-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = `
                <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span>Génération en cours...</span>
            `;
            btn.disabled = true;

            setTimeout(() => {
                try {
                    generatePDF(pack);
                    showToast('PDF téléchargé avec succès !');
                } catch (error) {
                    console.error('PDF Error:', error);
                    showToast('Erreur lors de la génération du PDF', 'error');
                } finally {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }, 100);
        }

        function generatePDF(pack) {
            const { jsPDF } = window.jspdf;

            const pageWidth = 297;
            const pageHeight = 210;
            const cols = 4;
            const rows = 4;
            const cardsPerPage = cols * rows;
            const cardWidth = pageWidth / cols;
            const cardHeight = pageHeight / rows;
            const margin = 4;

            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            const cards = pack.cards;
            const totalPages = Math.ceil(cards.length / cardsPerPage);

            for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
                if (pageIndex > 0) pdf.addPage();

                const startIdx = pageIndex * cardsPerPage;
                const endIdx = Math.min(startIdx + cardsPerPage, cards.length);

                for (let i = startIdx; i < endIdx; i++) {
                    const localIdx = i - startIdx;
                    const col = localIdx % cols;
                    const row = Math.floor(localIdx / cols);

                    const x = col * cardWidth;
                    const y = row * cardHeight;

                    drawCard(pdf, cards[i].question, i + 1, x, y, cardWidth, cardHeight, margin, true);
                }

                drawCutLines(pdf, pageWidth, pageHeight, cols, rows, cardWidth, cardHeight);
            }

            for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
                pdf.addPage();

                const startIdx = pageIndex * cardsPerPage;
                const endIdx = Math.min(startIdx + cardsPerPage, cards.length);

                for (let i = startIdx; i < endIdx; i++) {
                    const localIdx = i - startIdx;
                    const col = localIdx % cols;
                    const row = Math.floor(localIdx / cols);

                    const mirroredCol = (cols - 1) - col;

                    const x = mirroredCol * cardWidth;
                    const y = row * cardHeight;

                    drawCard(pdf, cards[i].answer, i + 1, x, y, cardWidth, cardHeight, margin, false);
                }

                drawCutLines(pdf, pageWidth, pageHeight, cols, rows, cardWidth, cardHeight);
            }

            const date = new Date().toISOString().slice(0, 10);
            const sanitizedTitle = pack.title.replace(/[^a-zA-Z0-9]/g, '_');
            const filename = `CamCardsV2_${sanitizedTitle}_${date}.pdf`;

            pdf.save(filename);
        }

        function drawCard(pdf, text, cardNum, x, y, width, height, margin, isRecto) {
            const centerX = x + width / 2;
            const centerY = y + height / 2;

            if (isRecto) pdf.setFillColor(250, 248, 255);
            else pdf.setFillColor(237, 233, 254);
            pdf.rect(x + 1, y + 1, width - 2, height - 2, 'F');

            if (!isRecto) {
                pdf.setDrawColor(196, 181, 253);
                pdf.setLineWidth(0.5);
                pdf.rect(x + 2, y + 2, width - 4, height - 4, 'S');
            }

            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            if (isRecto) pdf.setTextColor(124, 58, 237);
            else pdf.setTextColor(109, 40, 217);
            pdf.text(String(cardNum), x + margin + 2, y + margin + 5);

            pdf.setFontSize(7);
            pdf.setFont('helvetica', 'normal');
            if (isRecto) {
                pdf.setTextColor(167, 139, 250);
                pdf.text('QUESTION', centerX, y + margin + 4, { align: 'center' });
            } else {
                pdf.setTextColor(139, 92, 246);
                pdf.text('REPONSE', centerX, y + margin + 4, { align: 'center' });
            }

            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'normal');
            if (isRecto) pdf.setTextColor(31, 41, 55);
            else pdf.setTextColor(55, 48, 89);

            const maxWidth = width - (margin * 2) - 4;
            const lines = pdf.splitTextToSize(text, maxWidth);

            const lineHeight = 4;
            const totalTextHeight = lines.length * lineHeight;
            const startY = centerY - (totalTextHeight / 2) + 4;

            lines.forEach((line, idx) => {
                pdf.text(line, centerX, startY + (idx * lineHeight), { align: 'center' });
            });

            pdf.setFontSize(6);
            pdf.setFont('helvetica', 'italic');
            if (isRecto) pdf.setTextColor(196, 181, 253);
            else pdf.setTextColor(167, 139, 250);
            pdf.text('CamCards v2', x + width - margin - 2, y + height - margin - 1, { align: 'right' });
        }

        function drawCutLines(pdf, pageWidth, pageHeight, cols, rows, cardWidth, cardHeight) {
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.3);
            pdf.setLineDashPattern([2, 2], 0);

            for (let col = 1; col < cols; col++) {
                const x = col * cardWidth;
                pdf.line(x, 0, x, pageHeight);
            }

            for (let row = 1; row < rows; row++) {
                const y = row * cardHeight;
                pdf.line(0, y, pageWidth, y);
            }

            pdf.setLineDashPattern([], 0);
        }

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            // Au démarrage, on charge les données du backend
            loadData();
        });
    </script>
    <!-- MODAL DE BIENVENUE (S'affiche une seule fois) -->
    <div id="welcome-modal"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop hidden text-left">
        <div
            class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden welcome-card border border-violet-100 dark:border-slate-800">
            <div class="relative h-32 bg-gradient-to-br from-violet-600 to-indigo-700 flex items-center justify-center">
                <div class="absolute inset-0 opacity-20"
                    style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');"></div>
                <div
                    class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-lg transform -rotate-12">
                    <svg class="w-10 h-10 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
            </div>
            <div class="p-8 text-center">
                <h2 class="text-2xl font-extrabold text-gray-900 dark:text-white mb-4">Bienvenue sur CamCards v2 !</h2>
                <div class="space-y-4 text-gray-600 dark:text-slate-400 text-base leading-relaxed">
                    <p>Découvrez votre nouvel espace de révision intelligent conçu pour vous aider à réussir vos
                        examens.</p>
                    <div class="grid grid-cols-2 gap-4 py-4">
                        <div
                            class="p-3 bg-violet-50 dark:bg-slate-800 rounded-2xl border border-violet-100 dark:border-slate-700">
                            <span class="block text-xl mb-1">🗂️</span>
                            <span
                                class="text-xs font-bold text-violet-700 dark:text-violet-400 uppercase tracking-wider">Organisation</span>
                            <p class="text-[10px]">Par Niveau et Matière</p>
                        </div>
                        <div
                            class="p-3 bg-indigo-50 dark:bg-slate-800 rounded-2xl border border-indigo-100 dark:border-slate-700">
                            <span class="block text-xl mb-1">⚡</span>
                            <span
                                class="text-xs font-bold text-indigo-700 dark:text-indigo-400 uppercase tracking-wider">Mémorisation</span>
                            <p class="text-[10px]">Flashcards interactives</p>
                        </div>
                        <div
                            class="p-3 bg-amber-50 dark:bg-slate-800 rounded-2xl border border-amber-100 dark:border-slate-700">
                            <span class="block text-xl mb-1">🌓</span>
                            <span
                                class="text-xs font-bold text-amber-700 dark:text-amber-400 uppercase tracking-wider">Confort</span>
                            <p class="text-[10px]">Mode Sombre complet</p>
                        </div>
                        <div
                            class="p-3 bg-emerald-50 dark:bg-slate-800 rounded-2xl border border-emerald-100 dark:border-slate-700">
                            <span class="block text-xl mb-1">🎓</span>
                            <span
                                class="text-xs font-bold text-emerald-700 dark:text-emerald-400 uppercase tracking-wider">Réussite</span>
                            <p class="text-[10px]">Apprenez à votre rythme</p>
                        </div>
                    </div>
                    <p class="text-sm italic">Créez vos packs, testez vos connaissances et progressez simplement. Prêt à
                        commencer ?</p>
                </div>
                <button onclick="closeWelcomeModal()"
                    class="mt-8 w-full py-4 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-violet-200 dark:shadow-none hover:scale-[1.02] active:scale-[0.98] transition-all cursor-pointer">
                    C'est parti !
                </button>
            </div>
        </div>
    </div>
</body>

</html>